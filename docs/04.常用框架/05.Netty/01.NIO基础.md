---
title: NIOåŸºç¡€
date: 2024-10-26 14:56:58
permalink: /pages/c22ac9/
author: 
  name: Kiro
  link: https://cai2.wang

---

> æœ¬å¥—nettyçŸ¥è¯†ç‚¹ä¸ºé»‘é©¬ç¨‹åºå‘˜-nettyçš„å­¦ä¹ è®°å½•ï¼š[ä¼ é€é—¨](https://www.bilibili.com/video/BV1py4y1E7oA/?vd_source=fa704bb6a5b4c24699d6dde3e3cad6d2)



> non-blocking io éé˜»å¡ IO

## ä¸‰å¤§ç»„ä»¶

### Channel & Buffer

channel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„**åŒå‘é€šé“**ï¼Œå¯ä»¥ä» channel å°†æ•°æ®è¯»å…¥ bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥ channelï¼Œè€Œä¹‹å‰çš„ stream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯” stream æ›´ä¸ºåº•å±‚

```mermaid
graph LR
channel --> buffer
buffer --> channel
```

Java NIOç³»ç»Ÿçš„**æ ¸å¿ƒ**åœ¨äºï¼š**é€šé“(Channel)å’Œç¼“å†²åŒº(Buffer)**ã€‚é€šé“è¡¨ç¤ºæ‰“å¼€åˆ° IO è®¾å¤‡(ä¾‹å¦‚ï¼šæ–‡ä»¶ã€å¥—æ¥å­—)çš„è¿æ¥ã€‚è‹¥éœ€è¦ä½¿ç”¨ NIO ç³»ç»Ÿï¼Œéœ€è¦è·å–ç”¨äº**è¿æ¥ IO è®¾å¤‡çš„é€šé“**ä»¥åŠç”¨äº**å®¹çº³æ•°æ®çš„ç¼“å†²åŒº**ã€‚ç„¶åæ“ä½œç¼“å†²åŒºï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†

ç®€è€Œè¨€ä¹‹ï¼Œ**é€šé“è´Ÿè´£ä¼ è¾“ï¼Œç¼“å†²åŒºè´Ÿè´£å­˜å‚¨**

**å¸¸è§çš„Channelæœ‰ä»¥ä¸‹å››ç§**ï¼Œå…¶ä¸­`FileChannel`ä¸»è¦ç”¨äºæ–‡ä»¶ä¼ è¾“ï¼Œå…¶ä½™ä¸‰ç§ç”¨äºç½‘ç»œé€šä¿¡

* `FileChannel`
* `DatagramChannel`
* `SocketChannel`
* `ServerSocketChannel`



**Bufferæœ‰ä»¥ä¸‹å‡ ç§**ï¼Œå…¶ä¸­ä½¿ç”¨è¾ƒå¤šçš„æ˜¯ByteBuffer

* `ByteBuffer`
  * `MappedByteBuffer`
  * `DirectByteBuffer`
  * `HeapByteBuffer`
* `ShortBuffer`
* `IntBuffer`
* `LongBuffer`
* `FloatBuffer`
* `DoubleBuffer`
* `CharBuffer`

![](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/20241026171112.png)

### Selector

selector å•ä»å­—é¢æ„æ€ä¸å¥½ç†è§£ï¼Œéœ€è¦ç»“åˆæœåŠ¡å™¨çš„è®¾è®¡æ¼”åŒ–æ¥ç†è§£å®ƒçš„ç”¨é€”

åœ¨ä½¿ç”¨Selectorä¹‹å‰ï¼Œå¤„ç†socketè¿æ¥è¿˜æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•

**ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯**

ä¸ºæ¯ä¸ªè¿æ¥åˆ†åˆ«å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«å»å¤„ç†å¯¹åº”çš„sockeè¿æ¥

```mermaid
graph TD
subgraph å¤šçº¿ç¨‹ç‰ˆ
t1(thread) --> s1(socket1)
t2(thread) --> s2(socket2)
t3(thread) --> s3(socket3)
end
```

è¿™ç§æ–¹æ³•å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

- å†…å­˜å ç”¨é«˜
  - æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦å ç”¨ä¸€å®šçš„å†…å­˜ï¼Œå½“è¿æ¥è¾ƒå¤šæ—¶ï¼Œä¼šå¼€è¾Ÿå¤§é‡çº¿ç¨‹ï¼Œå¯¼è‡´å ç”¨å¤§é‡å†…å­˜
- çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜
- åªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯
  - è¿æ¥æ•°è¿‡å¤šï¼Œä¼šå¯¼è‡´åˆ›å»ºå¾ˆå¤šçº¿ç¨‹ï¼Œä»è€Œå‡ºç°é—®é¢˜

**ä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯**

ä½¿ç”¨çº¿ç¨‹æ± ï¼Œè®©çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å»å¤„ç†è¿æ¥

```mermaid
graph TD
subgraph çº¿ç¨‹æ± ç‰ˆ
t4(thread) --> s4(socket1)
t5(thread) --> s5(socket2)
t4(thread) -.-> s6(socket3)
t5(thread) -.-> s7(socket4)
end
```

è¿™ç§æ–¹æ³•å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

- é˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ªè¿æ¥
  - çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è·å–ä»»åŠ¡ï¼ˆtaskï¼‰åï¼Œåªæœ‰å½“å…¶æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼ˆæ–­å¼€è¿æ¥åï¼‰ï¼Œæ‰ä¼šå»è·å–å¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
  - è‹¥socketè¿æ¥ä¸€ç›´æœªæ–­å¼€ï¼Œåˆ™å…¶å¯¹åº”çš„çº¿ç¨‹æ— æ³•å¤„ç†å…¶ä»–socketè¿æ¥
- ä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯
  - çŸ­è¿æ¥å³å»ºç«‹è¿æ¥å‘é€è¯·æ±‚å¹¶å“åº”åå°±ç«‹å³æ–­å¼€ï¼Œä½¿å¾—çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯ä»¥å¿«é€Ÿå¤„ç†å…¶ä»–è¿æ¥

**ä½¿ç”¨é€‰æ‹©å™¨**

**selector çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channelï¼ˆfileChannelå› ä¸ºæ˜¯é˜»å¡å¼çš„ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨selectorï¼‰**ï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„**äº‹ä»¶**ï¼Œè¿™äº› channel å·¥ä½œåœ¨**éé˜»å¡æ¨¡å¼**ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚å½“ä¸€ä¸ªchannelä¸­æ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶ä»–channelä¸­çš„ä»»åŠ¡ã€‚**é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯**ï¼ˆlow trafficï¼‰

```mermaid
graph TD
subgraph selector ç‰ˆ
thread --> selector
selector --> c1(channel)
selector --> c2(channel)
selector --> c3(channel)
end
```

è‹¥äº‹ä»¶æœªå°±ç»ªï¼Œè°ƒç”¨ `selector` çš„ `select()` æ–¹æ³•ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ° `channel` å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶å°±ç»ªåï¼Œ`select` æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ `thread` æ¥å¤„ç†

### ByteBuffer

#### ä½¿ç”¨æ–¹å¼

1. å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ `channel.read(buffer)`
2. è°ƒç”¨ `flip()` åˆ‡æ¢è‡³`è¯»æ¨¡å¼`
   - **flipä¼šä½¿å¾—bufferä¸­çš„limitå˜ä¸ºpositionï¼Œpositionå˜ä¸º0**
3. ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()
4. è°ƒç”¨ `clear()` æˆ–è€…`compact()`åˆ‡æ¢è‡³`å†™æ¨¡å¼`
   - è°ƒç”¨clear()æ–¹æ³•æ—¶**position=0ï¼Œlimitå˜ä¸ºcapacity**
   - è°ƒç”¨compact()æ–¹æ³•æ—¶ï¼Œ**ä¼šå°†ç¼“å†²åŒºä¸­çš„æœªè¯»æ•°æ®å‹ç¼©åˆ°ç¼“å†²åŒºå‰é¢**
5. é‡å¤ä»¥ä¸Šæ­¥éª¤

#### ä½¿ç”¨æ¡ˆä¾‹

æœ‰ä¸€æ™®é€šæ–‡æœ¬æ–‡ä»¶ data.txtï¼Œå†…å®¹ä¸º

```txt
1234567890abcd
```

ä½¿ç”¨ `FileChannel` æ¥è¯»å–æ–‡ä»¶å†…å®¹

```java
@Slf4j
public class ChannelDemo1 {
    public static void main(String[] args) {
        try (RandomAccessFile file = new RandomAccessFile("helloword/data.txt", "rw")) {
            FileChannel channel = file.getChannel();
            ByteBuffer buffer = ByteBuffer.allocate(10);
            do {
                // å‘ buffer å†™å…¥
                int len = channel.read(buffer);
                log.debug("è¯»åˆ°å­—èŠ‚æ•°ï¼š{}", len);
                if (len == -1) {
                    break;
                }
                // åˆ‡æ¢ buffer è¯»æ¨¡å¼
                buffer.flip();
                while(buffer.hasRemaining()) {
                    log.debug("{}", (char)buffer.get());
                }
                // åˆ‡æ¢ buffer å†™æ¨¡å¼
                buffer.clear();
            } while (true);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

è¾“å‡º

```
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š10
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š-1
```

#### æ ¸å¿ƒå±æ€§

å­—èŠ‚ç¼“å†²åŒºçš„çˆ¶ç±»Bufferä¸­æœ‰å‡ ä¸ªæ ¸å¿ƒå±æ€§ï¼Œå¦‚ä¸‹

```java
// Invariants: mark <= position <= limit <= capacity
private int mark = -1;
private int position = 0;
private int limit;
private int capacity;
```

- **capacity**ï¼šç¼“å†²åŒºçš„å®¹é‡ã€‚é€šè¿‡æ„é€ å‡½æ•°èµ‹äºˆï¼Œä¸€æ—¦è®¾ç½®ï¼Œæ— æ³•æ›´æ”¹
- **limit**ï¼šç¼“å†²åŒºçš„ç•Œé™ã€‚ä½äºlimit åçš„æ•°æ®ä¸å¯è¯»å†™ã€‚ç¼“å†²åŒºçš„é™åˆ¶ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”**ä¸èƒ½å¤§äºå…¶å®¹é‡**
- **position**ï¼š**ä¸‹ä¸€ä¸ª**è¯»å†™ä½ç½®çš„ç´¢å¼•ã€‚ç¼“å†²åŒºçš„ä½ç½®ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”**ä¸èƒ½å¤§äºlimit**
- **mark**ï¼šè®°å½•å½“å‰positionçš„å€¼ã€‚**positionè¢«æ”¹å˜åï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨reset() æ–¹æ³•æ¢å¤åˆ°markçš„ä½ç½®**ã€‚

ä»¥ä¸Šå››ä¸ªå±æ€§å¿…é¡»æ»¡è¶³ä»¥ä¸‹è¦æ±‚

**mark <= position <= limit <= capacity**

ä¸€å¼€å§‹

![0021](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0021.png)

å†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€

![0018](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0018.png)

flip åŠ¨ä½œå‘ç”Ÿåï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶

![0019](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0019.png)

è¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€

![0020](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0020.png)

clear åŠ¨ä½œå‘ç”Ÿåï¼ŒçŠ¶æ€

![0021](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0021.png)

compact æ–¹æ³•ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼

![0022](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0022.png)

>  **clear() VS compact()**
>  clearåªæ˜¯å¯¹positionã€limitã€markè¿›è¡Œé‡ç½®ï¼Œè€Œcompactåœ¨å¯¹positionè¿›è¡Œè®¾ç½®ï¼Œä»¥åŠlimitã€markè¿›è¡Œé‡ç½®çš„åŒæ—¶ï¼Œè¿˜æ¶‰åŠåˆ°æ•°æ®åœ¨å†…å­˜ä¸­æ‹·è´ï¼ˆä¼šè°ƒç”¨`arraycopy`ï¼‰ã€‚**æ‰€ä»¥compactæ¯”clearæ›´è€—æ€§èƒ½ã€‚**ä½†compactèƒ½ä¿å­˜ä½ æœªè¯»å–çš„æ•°æ®ï¼Œå°†æ–°æ•°æ®è¿½åŠ åˆ°ä¸ºè¯»å–çš„æ•°æ®ä¹‹åï¼›è€Œclearåˆ™ä¸è¡Œï¼Œè‹¥ä½ è°ƒç”¨äº†clearï¼Œåˆ™æœªè¯»å–çš„æ•°æ®å°±æ— æ³•å†è¯»å–åˆ°äº†
>
>  **æ‰€ä»¥éœ€è¦æ ¹æ®æƒ…å†µæ¥åˆ¤æ–­ä½¿ç”¨å“ªç§æ–¹æ³•è¿›è¡Œæ¨¡å¼åˆ‡æ¢**

#### ByteBuffer å¸¸è§æ–¹æ³•

##### åˆ†é…ç©ºé—´

å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•

```java
Bytebuffer buf = ByteBuffer.allocate(16);
```

##### å‘ buffer å†™å…¥æ•°æ®

æœ‰ä¸¤ç§åŠæ³•

* è°ƒç”¨ channel çš„ read æ–¹æ³•
* è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•

```java
int readBytes = channel.read(buf);
```

å’Œ

```java
buf.put((byte)127);
```



##### ä» buffer è¯»å–æ•°æ®

åŒæ ·æœ‰ä¸¤ç§åŠæ³•

* è°ƒç”¨ channel çš„ write æ–¹æ³•
* è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•

```java
int writeBytes = channel.write(buf);
```

å’Œ

```java
byte b = buf.get();
```

get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœæƒ³é‡å¤è¯»å–æ•°æ®

* å¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0
* æˆ–è€…**è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ**

##### mark å’Œ reset

mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®

> **æ³¨æ„**
>
> rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®

#### æ–¹æ³•è°ƒç”¨åŠæ¼”ç¤º

éœ€è¦å…ˆå¯¼å…¥nettyä¾èµ–

```xml
<dependency>
  <groupId>io.netty</groupId>
  <artifactId>netty-all</artifactId>
  <version>4.1.51.Final</version>
</dependency>
```



##### ğŸ’¡ è°ƒè¯•å·¥å…·ç±»

```java
public class ByteBufferUtil {
    private static final char[] BYTE2CHAR = new char[256];
    private static final char[] HEXDUMP_TABLE = new char[256 * 4];
    private static final String[] HEXPADDING = new String[16];
    private static final String[] HEXDUMP_ROWPREFIXES = new String[65536 >>> 4];
    private static final String[] BYTE2HEX = new String[256];
    private static final String[] BYTEPADDING = new String[16];

    static {
        final char[] DIGITS = "0123456789abcdef".toCharArray();
        for (int i = 0; i < 256; i++) {
            HEXDUMP_TABLE[i << 1] = DIGITS[i >>> 4 & 0x0F];
            HEXDUMP_TABLE[(i << 1) + 1] = DIGITS[i & 0x0F];
        }

        int i;

        // Generate the lookup table for hex dump paddings
        for (i = 0; i < HEXPADDING.length; i++) {
            int padding = HEXPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding * 3);
            for (int j = 0; j < padding; j++) {
                buf.append("   ");
            }
            HEXPADDING[i] = buf.toString();
        }

        // Generate the lookup table for the start-offset header in each row (up to 64KiB).
        for (i = 0; i < HEXDUMP_ROWPREFIXES.length; i++) {
            StringBuilder buf = new StringBuilder(12);
            buf.append(NEWLINE);
            buf.append(Long.toHexString(i << 4 & 0xFFFFFFFFL | 0x100000000L));
            buf.setCharAt(buf.length() - 9, '|');
            buf.append('|');
            HEXDUMP_ROWPREFIXES[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-hex-dump conversion
        for (i = 0; i < BYTE2HEX.length; i++) {
            BYTE2HEX[i] = ' ' + StringUtil.byteToHexStringPadded(i);
        }

        // Generate the lookup table for byte dump paddings
        for (i = 0; i < BYTEPADDING.length; i++) {
            int padding = BYTEPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding);
            for (int j = 0; j < padding; j++) {
                buf.append(' ');
            }
            BYTEPADDING[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-char conversion
        for (i = 0; i < BYTE2CHAR.length; i++) {
            if (i <= 0x1f || i >= 0x7f) {
                BYTE2CHAR[i] = '.';
            } else {
                BYTE2CHAR[i] = (char) i;
            }
        }
    }

    /**
     * æ‰“å°æ‰€æœ‰å†…å®¹
     * @param buffer
     */
    public static void debugAll(ByteBuffer buffer) {
        int oldlimit = buffer.limit();
        buffer.limit(buffer.capacity());
        StringBuilder origin = new StringBuilder(256);
        appendPrettyHexDump(origin, buffer, 0, buffer.capacity());
        System.out.println("+--------+-------------------- all ------------------------+----------------+");
        System.out.printf("position: [%d], limit: [%d]\n", buffer.position(), oldlimit);
        System.out.println(origin);
        buffer.limit(oldlimit);
    }

    /**
     * æ‰“å°å¯è¯»å–å†…å®¹
     * @param buffer
     */
    public static void debugRead(ByteBuffer buffer) {
        StringBuilder builder = new StringBuilder(256);
        appendPrettyHexDump(builder, buffer, buffer.position(), buffer.limit() - buffer.position());
        System.out.println("+--------+-------------------- read -----------------------+----------------+");
        System.out.printf("position: [%d], limit: [%d]\n", buffer.position(), buffer.limit());
        System.out.println(builder);
    }

    private static void appendPrettyHexDump(StringBuilder dump, ByteBuffer buf, int offset, int length) {
        if (isOutOfBounds(offset, length, buf.capacity())) {
            throw new IndexOutOfBoundsException(
                    "expected: " + "0 <= offset(" + offset + ") <= offset + length(" + length
                            + ") <= " + "buf.capacity(" + buf.capacity() + ')');
        }
        if (length == 0) {
            return;
        }
        dump.append(
                "         +-------------------------------------------------+" +
                        NEWLINE + "         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |" +
                        NEWLINE + "+--------+-------------------------------------------------+----------------+");

        final int startIndex = offset;
        final int fullRows = length >>> 4;
        final int remainder = length & 0xF;

        // Dump the rows which have 16 bytes.
        for (int row = 0; row < fullRows; row++) {
            int rowStartIndex = (row << 4) + startIndex;

            // Per-row prefix.
            appendHexDumpRowPrefix(dump, row, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + 16;
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(" |");

            // ASCII dump
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append('|');
        }

        // Dump the last row which has less than 16 bytes.
        if (remainder != 0) {
            int rowStartIndex = (fullRows << 4) + startIndex;
            appendHexDumpRowPrefix(dump, fullRows, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + remainder;
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(HEXPADDING[remainder]);
            dump.append(" |");

            // Ascii dump
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append(BYTEPADDING[remainder]);
            dump.append('|');
        }

        dump.append(NEWLINE +
                "+--------+-------------------------------------------------+----------------+");
    }

    private static void appendHexDumpRowPrefix(StringBuilder dump, int row, int rowStartIndex) {
        if (row < HEXDUMP_ROWPREFIXES.length) {
            dump.append(HEXDUMP_ROWPREFIXES[row]);
        } else {
            dump.append(NEWLINE);
            dump.append(Long.toHexString(rowStartIndex & 0xFFFFFFFFL | 0x100000000L));
            dump.setCharAt(dump.length() - 9, '|');
            dump.append('|');
        }
    }

    public static short getUnsignedByte(ByteBuffer buffer, int index) {
        return (short) (buffer.get(index) & 0xFF);
    }
}
```

##### è°ƒç”¨ByteBufferçš„æ–¹æ³•

```java
public class TestByteBuffer {
    public static void main(String[] args) {
        ByteBuffer buffer = ByteBuffer.allocate(10);
        // å‘bufferä¸­å†™å…¥1ä¸ªå­—èŠ‚çš„æ•°æ®
        buffer.put((byte)97);
        // ä½¿ç”¨å·¥å…·ç±»ï¼ŒæŸ¥çœ‹bufferçŠ¶æ€
        ByteBufferUtil.debugAll(buffer);

        // å‘bufferä¸­å†™å…¥4ä¸ªå­—èŠ‚çš„æ•°æ®
        buffer.put(new byte[]{98, 99, 100, 101});
        ByteBufferUtil.debugAll(buffer);

        // è·å–æ•°æ®
        buffer.flip();
        ByteBufferUtil.debugAll(buffer);
        System.out.println(buffer.get());
        System.out.println(buffer.get());
        ByteBufferUtil.debugAll(buffer);

        // ä½¿ç”¨compactåˆ‡æ¢æ¨¡å¼
        buffer.compact();
        ByteBufferUtil.debugAll(buffer);

        // å†æ¬¡å†™å…¥
        buffer.put((byte)102);
        buffer.put((byte)103);
        ByteBufferUtil.debugAll(buffer);
    }
}

```

è¿è¡Œç»“æœ

```
// å‘ç¼“å†²åŒºå†™å…¥äº†ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ­¤æ—¶postitionä¸º1
+--------+-------------------- all ------------------------+----------------+
position: [1], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 00 00 00 00 00 00 00 00 00                   |a.........      |
+--------+-------------------------------------------------+----------------+

// å‘ç¼“å†²åŒºå†™å…¥å››ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ­¤æ—¶positionä¸º5
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+

// è°ƒç”¨flipåˆ‡æ¢æ¨¡å¼ï¼Œæ­¤æ—¶positionä¸º0ï¼Œè¡¨ç¤ºä»ç¬¬0ä¸ªæ•°æ®å¼€å§‹è¯»å–
+--------+-------------------- all ------------------------+----------------+
position: [0], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+
// è¯»å–ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®             
97
98
            
// positionå˜ä¸º2             
+--------+-------------------- all ------------------------+----------------+
position: [2], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+
             
// è°ƒç”¨compactåˆ‡æ¢æ¨¡å¼ï¼Œæ­¤æ—¶positionåŠå…¶åé¢çš„æ•°æ®è¢«å‹ç¼©åˆ°ByteBufferå‰é¢å»äº†
// æ­¤æ—¶positionä¸º3ï¼Œä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®             
+--------+-------------------- all ------------------------+----------------+
position: [3], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 64 65 64 65 00 00 00 00 00                   |cdede.....      |
+--------+-------------------------------------------------+----------------+
             
// å†æ¬¡å†™å…¥ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä¹‹å‰çš„ 0x64 0x65 è¢«è¦†ç›–         
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 64 65 66 67 00 00 00 00 00                   |cdefg.....      |
+--------+-------------------------------------------------+----------------+

```

##### è°ƒç”¨ByteBufferçš„åˆ†é…å†…å­˜çš„æ–¹æ³•

```java
public class TestByteBufferAllocate {
    public static void main(String[] args) {
        ByteBuffer allocate = ByteBuffer.allocate(10);
        ByteBuffer allocateDirect = ByteBuffer.allocateDirect(10);
        System.out.println(allocate.getClass()); // class java.nio.HeapByteBuffer å †å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œæ‰€ä»¥æ”¶åˆ°åƒåœ¾(GC)å›æ”¶çš„å½±å“ï¼›è¯»å†™æ•ˆç‡ç›¸å¯¹ä¸é«˜ï¼›
        System.out.println(allocateDirect.getClass()); // class java.nio.DirectByteBuffer ç›´æ¥å†…å­˜(ç³»ç»Ÿå†…å­˜)é‡Œé¢çš„å¯¹è±¡ï¼Œä¸ä¼šå—åˆ°åƒåœ¾å›æ”¶çš„å½±å“ï¼›è¯»å†™æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œä¼šå°‘ä¸€æ¬¡çš„å¤åˆ¶æ‹·è´ï¼›åˆ†é…æ—¶çš„æ•ˆç‡æ¯”è¾ƒä½ï¼Œå¹¶ä¸”å®¹æ˜“å‡ºç°å†…å­˜æ³„éœ²ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾å†…å­˜
    }
}
```

#### å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬

##### æ–¹æ³•ä¸€

**ç¼–ç **ï¼šå­—ç¬¦ä¸²è°ƒç”¨getByteæ–¹æ³•è·å¾—byteæ•°ç»„ï¼Œå°†byteæ•°ç»„æ”¾å…¥ByteBufferä¸­

**è§£ç **ï¼š**å…ˆè°ƒç”¨ByteBufferçš„flipæ–¹æ³•ï¼Œç„¶åé€šè¿‡StandardCharsetsçš„decoderæ–¹æ³•è§£ç **

```java
public class Translate {
    public static void main(String[] args) {
        // å‡†å¤‡ä¸¤ä¸ªå­—ç¬¦ä¸²
        String str1 = "hello";
        String str2 = "";


        ByteBuffer buffer1 = ByteBuffer.allocate(16);
        // é€šè¿‡å­—ç¬¦ä¸²çš„getByteæ–¹æ³•è·å¾—å­—èŠ‚æ•°ç»„ï¼Œæ”¾å…¥ç¼“å†²åŒºä¸­
        buffer1.put(str1.getBytes());
        ByteBufferUtil.debugAll(buffer1);

        // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
        // åˆ‡æ¢æ¨¡å¼
        buffer1.flip();
        
        // é€šè¿‡StandardCharsetsè§£ç ï¼Œè·å¾—CharBufferï¼Œå†é€šè¿‡toStringè·å¾—å­—ç¬¦ä¸²
        str2 = StandardCharsets.UTF_8.decode(buffer1).toString();
        System.out.println(str2);
        ByteBufferUtil.debugAll(buffer1);
    }
}
```

è¿è¡Œç»“æœ

```
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [16]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f 00 00 00 00 00 00 00 00 00 00 00 |hello...........|
+--------+-------------------------------------------------+----------------+
hello
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f 00 00 00 00 00 00 00 00 00 00 00 |hello...........|
+--------+-------------------------------------------------+----------------+
```

##### æ–¹æ³•äºŒ

**ç¼–ç **ï¼šé€šè¿‡StandardCharsetsçš„encodeæ–¹æ³•è·å¾—ByteBufferï¼Œæ­¤æ—¶è·å¾—çš„ByteBufferä¸ºè¯»æ¨¡å¼ï¼Œæ— éœ€é€šè¿‡flipåˆ‡æ¢æ¨¡å¼

**è§£ç **ï¼šé€šè¿‡StandardCharsetsçš„decoderæ–¹æ³•è§£ç 

```java
public class Translate {
    public static void main(String[] args) {
        // å‡†å¤‡ä¸¤ä¸ªå­—ç¬¦ä¸²
        String str1 = "hello";
        String str2 = "";

        // é€šè¿‡StandardCharsetsçš„encodeæ–¹æ³•è·å¾—ByteBuffer
        // æ­¤æ—¶è·å¾—çš„ByteBufferä¸ºè¯»æ¨¡å¼ï¼Œæ— éœ€é€šè¿‡flipåˆ‡æ¢æ¨¡å¼
        ByteBuffer buffer1 = StandardCharsets.UTF_8.encode(str1);
        ByteBufferUtil.debugAll(buffer1);

        // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
        // é€šè¿‡StandardCharsetsè§£ç ï¼Œè·å¾—CharBufferï¼Œå†é€šè¿‡toStringè·å¾—å­—ç¬¦ä¸²
        str2 = StandardCharsets.UTF_8.decode(buffer1).toString();
        System.out.println(str2);
        ByteBufferUtil.debugAll(buffer1);
    }
}
```

è¿è¡Œç»“æœ

```
+--------+-------------------- all ------------------------+----------------+
position: [0], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
hello
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
```

#### âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨

> Buffer æ˜¯**éçº¿ç¨‹å®‰å…¨çš„**

#### ByteBufferåˆ†æ•£è¯»é›†ä¸­å†™

##### åˆ†æ•£è¯»

```java
public class TestScatteringRead {
    public static void main(String[] args) {
        // è·å–channelçš„ä¸¤ç§æ–¹å¼ 1. é€šè¿‡è¾“å…¥è¾“å‡ºæµgetChannelï¼›2. é€šè¿‡RandomAccessFile.getChannel()è·å–
        try (FileChannel channel = new RandomAccessFile("word1.txt", "r").getChannel()) {
            ByteBuffer allocate0 = ByteBuffer.allocate(3);
            ByteBuffer allocate1 = ByteBuffer.allocate(3);
            ByteBuffer allocate2 = ByteBuffer.allocate(5);

            // å°†é€šé“(channel)ä¸­çš„æ•°æ®ä¾æ¬¡è¯»å…¥ç¼“å­˜åŒºä¸­
            channel.read(new ByteBuffer[]{allocate0, allocate1, allocate2});
            // åˆ‡æ¢ç¼“å†²åŒºè¯»å†™æ¨¡å¼
            allocate0.flip();
            allocate1.flip();
            allocate2.flip();

            ByteBufferUtil.debugAll(allocate0);
            ByteBufferUtil.debugAll(allocate1);
            ByteBufferUtil.debugAll(allocate2);

        } catch (IOException e) {
        }
    }
}
```

##### é›†ä¸­å†™

```java
public class TestGatheringWrite {
    public static void main(String[] args) {
        // å°†æŒ‡å®šå­—ç¬¦ä¸²è½¬æ¢ä¸ºbytebuffer
        ByteBuffer buffer1 = StandardCharsets.UTF_8.encode("hello");
        ByteBuffer buffer2 = StandardCharsets.UTF_8.encode("word");
        ByteBuffer buffer3 = StandardCharsets.UTF_8.encode("æé›·");

        // è·å–åˆ°æ–‡ä»¶å¯¹åº”çš„é€šé“
        try (FileChannel channel = new RandomAccessFile("word2.txt", "rw").getChannel()) {
            // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥é€šé“ä¸­
            channel.write(new ByteBuffer[]{buffer1, buffer2, buffer3});
        } catch (IOException e) {
        }
    }
}
```

#### ç²˜(é»)åŒ…ä¸åŠåŒ…

##### ç°è±¡

ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ `\n` è¿›è¡Œåˆ†éš”
ä½†ç”±äºæŸç§åŸå› è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æœ‰3æ¡ä¸º

- `Hello,world\n`
- `Iâ€™m Nyima\n`
- `How are you?\n`

å˜æˆäº†ä¸‹é¢çš„ä¸¤ä¸ª byteBuffer (ç²˜åŒ…ï¼ŒåŠåŒ…)

- `Hello,world\nIâ€™m Nyima\nHo`
- `w are you?\n`

##### å‡ºç°åŸå› 

**ç²˜åŒ…**

å‘é€æ–¹åœ¨å‘é€æ•°æ®æ—¶ï¼Œå¹¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡åœ°å‘é€æ•°æ®ï¼Œè€Œæ˜¯**å°†æ•°æ®æ•´åˆåœ¨ä¸€èµ·**ï¼Œå½“æ•°æ®è¾¾åˆ°ä¸€å®šçš„æ•°é‡åå†ä¸€èµ·å‘é€ã€‚è¿™å°±ä¼šå¯¼è‡´å¤šæ¡ä¿¡æ¯è¢«æ”¾åœ¨ä¸€ä¸ªç¼“å†²åŒºä¸­è¢«ä¸€èµ·å‘é€å‡ºå»

**åŠåŒ…**

æ¥æ”¶æ–¹çš„ç¼“å†²åŒºçš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå½“æ¥æ”¶æ–¹çš„ç¼“å†²åŒºæ»¡äº†ä»¥åï¼Œå°±éœ€è¦**å°†ä¿¡æ¯æˆªæ–­**ï¼Œç­‰ç¼“å†²åŒºç©ºäº†ä»¥åå†ç»§ç»­æ”¾å…¥æ•°æ®ã€‚è¿™å°±ä¼šå‘ç”Ÿä¸€æ®µå®Œæ•´çš„æ•°æ®æœ€åè¢«æˆªæ–­çš„ç°è±¡

##### è§£å†³åŠæ³•

- é€šè¿‡get(index)æ–¹æ³•éå†ByteBufferï¼Œé‡åˆ°åˆ†éš”ç¬¦æ—¶è¿›è¡Œå¤„ç†ã€‚

  > **æ³¨æ„ï¼š**get(index)ä¸ä¼šæ”¹å˜positionçš„å€¼

  - è®°å½•è¯¥æ®µæ•°æ®é•¿åº¦ï¼Œä»¥ä¾¿äºç”³è¯·å¯¹åº”å¤§å°çš„ç¼“å†²åŒº
  - å°†ç¼“å†²åŒºçš„æ•°æ®é€šè¿‡get()æ–¹æ³•å†™å…¥åˆ°targetä¸­

- è°ƒç”¨**compactæ–¹æ³•**åˆ‡æ¢æ¨¡å¼ï¼Œå› ä¸ºç¼“å†²åŒºä¸­å¯èƒ½è¿˜æœ‰æœªè¯»çš„æ•°æ®

```java
public class ByteBufferDemo {
    public static void main(String[] args) {
        ByteBuffer buffer = ByteBuffer.allocate(32);
        // æ¨¡æ‹Ÿç²˜åŒ…+åŠåŒ…
        buffer.put("Hello,world\nI'm Nyima\nHo".getBytes());
        // è°ƒç”¨splitå‡½æ•°å¤„ç†
        split(buffer);
        buffer.put("w are you?\n".getBytes());
        split(buffer);
    }

    private static void split(ByteBuffer buffer) {
        // åˆ‡æ¢ä¸ºè¯»æ¨¡å¼
        buffer.flip();
        for(int i = 0; i < buffer.limit(); i++) {

            // éå†å¯»æ‰¾åˆ†éš”ç¬¦
            // get(i)ä¸ä¼šç§»åŠ¨position
            if (buffer.get(i) == '\n') {
                // ç¼“å†²åŒºé•¿åº¦
                int length = i+1-buffer.position();
                ByteBuffer target = ByteBuffer.allocate(length);
                // å°†å‰é¢çš„å†…å®¹å†™å…¥targetç¼“å†²åŒº
                for(int j = 0; j < length; j++) {
                    // å°†bufferä¸­çš„æ•°æ®å†™å…¥targetä¸­
                    target.put(buffer.get());
                }
                // æ‰“å°æŸ¥çœ‹ç»“æœ
                ByteBufferUtil.debugAll(target);
            }
        }
        // åˆ‡æ¢ä¸ºå†™æ¨¡å¼ï¼Œä½†æ˜¯ç¼“å†²åŒºå¯èƒ½æœªè¯»å®Œï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨compact
        buffer.compact();
    }
}

```

è¿è¡Œç»“æœ

```
+--------+-------------------- all ------------------------+----------------+
position: [12], limit: [12]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 48 65 6c 6c 6f 2c 77 6f 72 6c 64 0a             |Hello,world.    |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [10], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 49 27 6d 20 4e 79 69 6d 61 0a                   |I'm Nyima.      |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [13], limit: [13]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 48 6f 77 20 61 72 65 20 79 6f 75 3f 0a          |How are you?.   |
+--------+-------------------------------------------------+----------------+
```

## æ–‡ä»¶ç¼–ç¨‹

### FileChannel

#### âš ï¸ FileChannel å·¥ä½œæ¨¡å¼

> FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥æ— æ³•æ­é…Selector

#### è·å–

ä¸èƒ½ç›´æ¥æ‰“å¼€ `FileChannel`ï¼Œ**å¿…é¡»**é€šè¿‡ `FileInputStream`ã€`FileOutputStream` æˆ–è€… `RandomAccessFile` æ¥è·å– `FileChannel`ï¼Œå®ƒä»¬éƒ½æœ‰ `getChannel` æ–¹æ³•

* é€šè¿‡ `FileInputStream` è·å–çš„ channel **åªèƒ½è¯»**
* é€šè¿‡ `FileOutputStream` è·å–çš„ channel **åªèƒ½å†™**
* é€šè¿‡ `RandomAccessFile` æ˜¯å¦èƒ½è¯»å†™**æ ¹æ®æ„é€  `RandomAccessFile` æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š**

#### è¯»å–

é€šè¿‡ `FileInputStream` è·å–channelï¼Œé€šè¿‡readæ–¹æ³•å°†æ•°æ®å†™å…¥åˆ°`ByteBuffer`ä¸­

readæ–¹æ³•çš„è¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œè‹¥è¯»åˆ°äº†æ–‡ä»¶æœ«å°¾åˆ™è¿”å›-1

```java
int readBytes = channel.read(buffer);
```

**å¯æ ¹æ®è¿”å›å€¼åˆ¤æ–­æ˜¯å¦è¯»å–å®Œæ¯•**

```java
while(channel.read(buffer) > 0) {
    // è¿›è¡Œå¯¹åº”æ“ä½œ
    ...
}
```



#### å†™å…¥

å› ä¸ºchannelä¹Ÿæ˜¯æœ‰å¤§å°çš„ï¼Œæ‰€ä»¥ write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channelã€‚å¿…é¡»**éœ€è¦æŒ‰ç…§ä»¥ä¸‹è§„åˆ™è¿›è¡Œå†™å…¥**

å†™å…¥çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼Œ `SocketChannel`

```java
ByteBuffer buffer = ...;
buffer.put(...); // å­˜å…¥æ•°æ®
buffer.flip();   // åˆ‡æ¢è¯»æ¨¡å¼

// é€šè¿‡hasRemaining()æ–¹æ³•æŸ¥çœ‹ç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®æœªå†™å…¥åˆ°é€šé“ä¸­
while(buffer.hasRemaining()) {
    channel.write(buffer);
}
```

åœ¨ while ä¸­è°ƒç”¨ `channel.write` æ˜¯å› ä¸º write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel

#### å…³é—­

é€šé“éœ€è¦closeï¼Œä¸€èˆ¬æƒ…å†µé€šè¿‡try-with-resourceè¿›è¡Œå…³é—­ï¼Œ**æœ€å¥½ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è·å–streamä»¥åŠchannelï¼Œé¿å…æŸäº›åŸå› ä½¿å¾—èµ„æºæœªè¢«å…³é—­**

è°ƒç”¨äº† `FileInputStream`ã€`FileOutputStream` æˆ–è€… `RandomAccessFile` çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•

```java
public class TestChannel {
    public static void main(String[] args) throws IOException {
        try (FileInputStream fis = new FileInputStream("stu.txt");
             FileOutputStream fos = new FileOutputStream("student.txt");
             FileChannel inputChannel = fis.getChannel();
             FileChannel outputChannel = fos.getChannel()) {
            
            // æ‰§è¡Œå¯¹åº”æ“ä½œ
            ...
                
        }
    }
}
```

#### ä½ç½®

**position**

channelä¹Ÿæ‹¥æœ‰ä¸€ä¸ªä¿å­˜è¯»å–æ•°æ®ä½ç½®çš„å±æ€§ï¼Œå³position

```java
long pos = channel.position();
```

å¯ä»¥é€šè¿‡position(int pos)è®¾ç½®channelä¸­positionçš„å€¼

```java
long newPos = ...;
channel.position(newPos);
```

è®¾ç½®å½“å‰ä½ç½®æ—¶ï¼Œå¦‚æœè®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾

* è¿™æ—¶è¯»å–ä¼šè¿”å› -1 
* è¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ï¼ˆ00ï¼‰

#### å¤§å°

ä½¿ç”¨ size æ–¹æ³•è·å–æ–‡ä»¶çš„å¤§å°

#### å¼ºåˆ¶å†™å…¥

æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ï¼Œä¸æ˜¯ç«‹åˆ»å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯ç­‰åˆ°ç¼“å­˜æ»¡äº†ä»¥åå°†æ‰€æœ‰æ•°æ®ä¸€æ¬¡æ€§çš„å†™å…¥ç£ç›˜ã€‚å¯ä»¥è°ƒç”¨ **force(true)** æ–¹æ³•å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜

### ä¸¤ä¸ªChannelä¼ è¾“æ•°æ®

#### transferToæ–¹æ³•

ä½¿ç”¨`transferTo`æ–¹æ³•å¯ä»¥å¿«é€Ÿã€é«˜æ•ˆåœ°å°†ä¸€ä¸ª`channel`ä¸­çš„æ•°æ®ä¼ è¾“åˆ°å¦ä¸€ä¸ª`channel`ä¸­ï¼Œä½†**ä¸€æ¬¡åªèƒ½ä¼ è¾“2Gçš„å†…å®¹**

`transferTo`åº•å±‚ä½¿ç”¨äº†é›¶æ‹·è´æŠ€æœ¯

```java
public class TestChannel {
    public static void main(String[] args){
        try (FileInputStream fis = new FileInputStream("stu.txt");
             FileOutputStream fos = new FileOutputStream("student.txt");
             FileChannel inputChannel = fis.getChannel();
             FileChannel outputChannel = fos.getChannel()) {
            // å‚æ•°ï¼šinputChannelçš„èµ·å§‹ä½ç½®ï¼Œä¼ è¾“æ•°æ®çš„å¤§å°ï¼Œç›®çš„channel
            // è¿”å›å€¼ä¸ºä¼ è¾“çš„æ•°æ®çš„å­—èŠ‚æ•°
            // transferToä¸€æ¬¡åªèƒ½ä¼ è¾“2Gçš„æ•°æ®
            inputChannel.transferTo(0, inputChannel.size(), outputChannel);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

å½“ä¼ è¾“çš„æ–‡ä»¶**å¤§äº2G**æ—¶ï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œå¤šæ¬¡ä¼ è¾“

```java
public class TestChannel {
    public static void main(String[] args){
        try (FileInputStream fis = new FileInputStream("stu.txt");
             FileOutputStream fos = new FileOutputStream("student.txt");
             FileChannel inputChannel = fis.getChannel();
             FileChannel outputChannel = fos.getChannel()) {
            long size = inputChannel.size();
            long capacity = inputChannel.size();
            // åˆ†å¤šæ¬¡ä¼ è¾“
            while (capacity > 0) {
                // transferToè¿”å›å€¼ä¸ºä¼ è¾“äº†çš„å­—èŠ‚æ•°
                capacity -= inputChannel.transferTo(size-capacity, capacity, outputChannel);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### Pathä¸Paths

jdk7 å¼•å…¥äº† Path å’Œ Paths ç±»

* Path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„
* Paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹

```java
Path source = Paths.get("1.txt"); // ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt

Path source = Paths.get("d:\\1.txt"); // ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\1.txt

Path source = Paths.get("d:/1.txt"); // ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\1.txt

Path projects = Paths.get("d:\\data", "projects"); // ä»£è¡¨äº†  d:\data\projects
```

* `.` ä»£è¡¨äº†å½“å‰è·¯å¾„
* `..` ä»£è¡¨äº†ä¸Šä¸€çº§è·¯å¾„

ä¾‹å¦‚ç›®å½•ç»“æ„å¦‚ä¸‹

```
d:
	|- data
		|- projects
			|- a
			|- b
```

ä»£ç 

```java
Path path = Paths.get("d:\\data\\projects\\a\\..\\b");
System.out.println(path);
System.out.println(path.normalize()); // æ­£å¸¸åŒ–è·¯å¾„ä¼šå»é™¤ . ä»¥åŠ ..
```

è¾“å‡ºç»“æœä¸º

```
d:\data\projects\a\..\b
d:\data\projects\b
```

### Files

#### æŸ¥æ‰¾

æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨

```java
Path path = Paths.get("helloword/data.txt");
System.out.println(Files.exists(path));
```

#### åˆ›å»º

åˆ›å»º**ä¸€çº§ç›®å½•**

```java
Path path = Paths.get("helloword/d1");
Files.createDirectory(path);
```

* å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ `FileAlreadyExistsException`
* ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ `NoSuchFileException`

åˆ›å»º**å¤šçº§ç›®å½•ç”¨**

```java
Path path = Paths.get("helloword/d1/d2");
Files.createDirectories(path);
```

#### æ‹·è´åŠç§»åŠ¨

**æ‹·è´æ–‡ä»¶**

```java
Path source = Paths.get("helloword/data.txt");
Path target = Paths.get("helloword/target.txt");

Files.copy(source, target);
```

* å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ `FileAlreadyExistsException`

å¦‚æœå¸Œæœ›ç”¨ `source` è¦†ç›–æ‰ `target`ï¼Œéœ€è¦ç”¨ `StandardCopyOption` æ¥æ§åˆ¶

```java
Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);
```



ç§»åŠ¨æ–‡ä»¶

```java
Path source = Paths.get("helloword/data.txt");
Path target = Paths.get("helloword/data.txt");

Files.move(source, target, StandardCopyOption.ATOMIC_MOVE);
```

* **`StandardCopyOption.ATOMIC_MOVE` ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§**

åˆ é™¤æ–‡ä»¶

```java
Path target = Paths.get("helloword/target.txt");

Files.delete(target);
```

* å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ `NoSuchFileException`

åˆ é™¤ç›®å½•

```java
Path target = Paths.get("helloword/d1");

Files.delete(target);
```

* å¦‚æœ**ç›®å½•è¿˜æœ‰å†…å®¹**ï¼Œä¼šæŠ›å¼‚å¸¸ `DirectoryNotEmptyException`

#### éå†

å¯ä»¥**ä½¿ç”¨Fileså·¥å…·ç±»ä¸­çš„walkFileTree(Path, FileVisitor)æ–¹æ³•**ï¼Œå…¶ä¸­éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°

- `Path`ï¼šæ–‡ä»¶èµ·å§‹è·¯å¾„
- `FileVisitor`ï¼šæ–‡ä»¶è®¿é—®å™¨ï¼Œä½¿ç”¨è®¿é—®è€…æ¨¡å¼
  - æ¥å£çš„å®ç°ç±»`SimpleFileVisitor`æœ‰å››ä¸ªæ–¹æ³•ï¼š
    - `preVisitDirectory`ï¼šè®¿é—®ç›®å½•å‰çš„æ“ä½œ
    - `visitFile`ï¼šè®¿é—®æ–‡ä»¶çš„æ“ä½œ
    - `visitFileFailed`ï¼šè®¿é—®æ–‡ä»¶å¤±è´¥æ—¶çš„æ“ä½œ
    - `postVisitDirectory`ï¼šè®¿é—®ç›®å½•åçš„æ“ä½œ

éå†ç›®å½•æ–‡ä»¶

```java
public class TestWalkFileTree {
    public static void main(String[] args) throws IOException {
        Path path = Paths.get("D:\\JDK 8");
        // æ–‡ä»¶ç›®å½•æ•°ç›®
        AtomicInteger dirCount = new AtomicInteger();
        // æ–‡ä»¶æ•°ç›®
        AtomicInteger fileCount = new AtomicInteger();
        Files.walkFileTree(path, new SimpleFileVisitor<Path>(){
            @Override
            public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {
                System.out.println("===>"+dir);
                // å¢åŠ æ–‡ä»¶ç›®å½•æ•°
                dirCount.incrementAndGet();
                return super.preVisitDirectory(dir, attrs);
            }

            @Override
            public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {
                System.out.println(file);
                // å¢åŠ æ–‡ä»¶æ•°
                fileCount.incrementAndGet();
                return super.visitFile(file, attrs);
            }
        });
        // æ‰“å°æ•°ç›®
        System.out.println("æ–‡ä»¶ç›®å½•æ•°:"+dirCount.get());
        System.out.println("æ–‡ä»¶æ•°:"+fileCount.get());
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹

```
...
===>D:\JDK 8\lib\security\policy\unlimited
D:\JDK 8\lib\security\policy\unlimited\local_policy.jar
D:\JDK 8\lib\security\policy\unlimited\US_export_policy.jar
D:\JDK 8\lib\security\trusted.libraries
D:\JDK 8\lib\sound.properties
D:\JDK 8\lib\tzdb.dat
D:\JDK 8\lib\tzmappings
D:\JDK 8\LICENSE
æ–‡ä»¶ç›®å½•æ•°:23
æ–‡ä»¶æ•°:280
```

ç»Ÿè®¡ jar çš„æ•°ç›®

```java
Path path = Paths.get("C:\\Program Files\\Java\\jdk1.8.0_91");
AtomicInteger fileCount = new AtomicInteger();
Files.walkFileTree(path, new SimpleFileVisitor<Path>(){
    @Override
    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) 
        throws IOException {
        if (file.toFile().getName().endsWith(".jar")) {
            fileCount.incrementAndGet();
        }
        return super.visitFile(file, attrs);
    }
});
System.out.println(fileCount); // 724
```



åˆ é™¤å¤šçº§ç›®å½•

```java
Path path = Paths.get("d:\\a");
Files.walkFileTree(path, new SimpleFileVisitor<Path>(){
    @Override
    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) 
        throws IOException {
        Files.delete(file);
        return super.visitFile(file, attrs);
    }

    @Override
    public FileVisitResult postVisitDirectory(Path dir, IOException exc) 
        throws IOException {
        Files.delete(dir);
        return super.postVisitDirectory(dir, exc);
    }
});
```

> âš ï¸ åˆ é™¤å¾ˆå±é™©
>
> åˆ é™¤æ˜¯å±é™©æ“ä½œï¼Œç¡®ä¿è¦é€’å½’åˆ é™¤çš„æ–‡ä»¶å¤¹æ²¡æœ‰é‡è¦å†…å®¹

æ‹·è´å¤šçº§ç›®å½•

```java
long start = System.currentTimeMillis();
String source = "D:\\Snipaste-1.16.2-x64";
String target = "D:\\Snipaste-1.16.2-x64aaa";

Files.walk(Paths.get(source)).forEach(path -> {
    try {
        String targetName = path.toString().replace(source, target);
        // æ˜¯ç›®å½•
        if (Files.isDirectory(path)) {
            Files.createDirectory(Paths.get(targetName));
        }
        // æ˜¯æ™®é€šæ–‡ä»¶
        else if (Files.isRegularFile(path)) {
            Files.copy(path, Paths.get(targetName));
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
});
long end = System.currentTimeMillis();
System.out.println(end - start);
```

## ç½‘ç»œç¼–ç¨‹

### éé˜»å¡ vs é˜»å¡

#### é˜»å¡

- é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ
  - `ServerSocketChannel.accept` ä¼šåœ¨**æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶**è®©çº¿ç¨‹æš‚åœ
  - `SocketChannel.read` ä¼šåœ¨**é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶**è®©çº¿ç¨‹æš‚åœ
  - é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®ï¼Œä¸èƒ½å¤„ç†å…¶ä»–çš„ä»»åŠ¡

* å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ
* ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢
  * **32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½**
  * å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œ**å› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥**

æœåŠ¡å™¨ç«¯

```java
public class Server {
    public static void main(String[] args) {
        // åˆ›å»ºç¼“å†²åŒº
        ByteBuffer buffer = ByteBuffer.allocate(16);
        // è·å¾—æœåŠ¡å™¨é€šé“
        try(ServerSocketChannel server = ServerSocketChannel.open()) {
            // ä¸ºæœåŠ¡å™¨é€šé“ç»‘å®šç«¯å£
            server.bind(new InetSocketAddress(8089));
            // ç”¨æˆ·å­˜æ”¾è¿æ¥çš„é›†åˆ
            ArrayList<SocketChannel> channels = new ArrayList<>();
            // å¾ªç¯æ¥æ”¶è¿æ¥
            while (true) {
                System.out.println("before connecting...");
                // æ²¡æœ‰è¿æ¥æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹
                SocketChannel socketChannel = server.accept();
                System.out.println("after connecting...");
                channels.add(socketChannel);
                // å¾ªç¯éå†é›†åˆä¸­çš„è¿æ¥
                for(SocketChannel channel : channels) {
                    System.out.println("before reading");
                    // å¤„ç†é€šé“ä¸­çš„æ•°æ®
                    // å½“é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹
                    channel.read(buffer);
                    buffer.flip();
                    ByteBufferUtil.debugRead(buffer);
                    buffer.clear();
                    System.out.println("after reading");
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

å®¢æˆ·ç«¯

```java
public class Client {
    public static void main(String[] args) {
        try (SocketChannel socketChannel = SocketChannel.open()) {
            socketChannel.connect(new InetSocketAddress("localhost", 8089));
            socketChannel.write(StandardCharsets.UTF_8.encode("hello"));
            System.out.println("waiting...");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

è¿è¡Œç»“æœ

- å®¢æˆ·ç«¯-æœåŠ¡å™¨å»ºç«‹è¿æ¥å‰ï¼šæœåŠ¡å™¨ç«¯å› accepté˜»å¡

![image-20241027003401988](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027003401988.png)

- å®¢æˆ·ç«¯-æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯å‰ï¼šæœåŠ¡å™¨ç«¯å› é€šé“ä¸ºç©ºè¢«é˜»å¡

![image-20241027003652183](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027003652183.png)

- å®¢æˆ·ç«¯å‘é€æ•°æ®åï¼ŒæœåŠ¡å™¨å¤„ç†é€šé“ä¸­çš„æ•°æ®ã€‚å†æ¬¡è¿›å…¥å¾ªç¯æ—¶ï¼Œå†æ¬¡è¢«accepté˜»å¡

![image-20241027003721424](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027003721424.png)

- ä¹‹å‰çš„å®¢æˆ·ç«¯å†æ¬¡å‘é€æ¶ˆæ¯**ï¼ŒæœåŠ¡å™¨ç«¯å› ä¸ºè¢«accepté˜»å¡**ï¼Œæ— æ³•å¤„ç†ä¹‹å‰å®¢æˆ·ç«¯å‘é€åˆ°é€šé“ä¸­çš„ä¿¡æ¯

![image-20241027005059928](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027005059928.png)

#### éé˜»å¡

- å¯ä»¥é€šè¿‡`ServerSocketChannel`çš„`configureBlocking(false)`æ–¹æ³•å°†**è·å¾—è¿æ¥**è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚æ­¤æ—¶è‹¥æ²¡æœ‰è¿æ¥ï¼Œ`accept`ä¼šè¿”å›`null`
- å¯ä»¥é€šè¿‡`SocketChannel`çš„`configureBlocking(false)`æ–¹æ³•å°†ä»é€šé“ä¸­**è¯»å–æ•°æ®**è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚**è‹¥æ­¤æ—¶é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œreadä¼šè¿”å›0**

* ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpu
* æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰

æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜

```
public class Server {
 public static void main(String[] args) {
        // åˆ›å»ºç¼“å†²åŒº
        ByteBuffer buffer = ByteBuffer.allocate(16);
        // è·å¾—æœåŠ¡å™¨é€šé“
        try (ServerSocketChannel serverSocketChannel = ServerSocketChannel.open()) {
            // ä¸ºæœåŠ¡å™¨é€šé“ç»‘å®šç«¯å£
            serverSocketChannel.bind(new InetSocketAddress(8089));
            // å°†æœåŠ¡ç«¯è¿æ¥é€šé“è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œæ­¤ç§çŠ¶æ¨¡å¼ï¼Œserver.accept()åœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚å»ºç«‹æ—¶ï¼Œè¿”å›å€¼æ˜¯nullæ­¤æ—¶è‹¥æ²¡æœ‰è¿æ¥ï¼Œacceptä¼šè¿”å›null
            serverSocketChannel.configureBlocking(false);
            // ç”¨æˆ·å­˜æ”¾è¿æ¥çš„é›†åˆ
            List<SocketChannel> channelList = new ArrayList<>();
            // å¾ªç¯æ¥æ”¶è¿æ¥
            while (true) {
                // configureBlocking = false ï¼ˆéé˜»å¡æ¨¡å¼ï¼‰ä¸‹ï¼Œæ‰§è¡Œåˆ°æ­¤ä»£ç ï¼Œå¦‚æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚å»ºç«‹ï¼Œè¿”å›å€¼ä¸ºnull
                SocketChannel socketChannel = serverSocketChannel.accept();
                // é€šé“ä¸ä¸ºç©ºæ—¶æ‰å°†è¿æ¥æ”¾å…¥åˆ°é›†åˆä¸­
                if (null != socketChannel) {
                    System.out.println("client connecting...");
                    // å®¢æˆ·ç«¯socketé€šé“ï¼Œè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œåˆ™ä½¿ç”¨channel.read()æ˜¯éé˜»å¡ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹çš„æ‰§è¡Œ
                    socketChannel.configureBlocking(false);
                    channelList.add(socketChannel);
                }
                for (SocketChannel channel : channelList) {
                    // å¤„ç†é€šé“ä¸­çš„æ•°æ®
                    // åœ¨é€šé“channelçš„configureBlocking = false ï¼ˆéé˜»å¡æ¨¡å¼ï¼‰ä¸‹ï¼Œè‹¥é€šé“ä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™è¿”å›å€¼æ˜¯0ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹çš„æ‰§è¡Œ
                    int read = channel.read(buffer);
                    if (read > 0) {
                        buffer.flip();
                        ByteBufferUtil.debugRead(buffer);
                        buffer.clear();
                        System.out.println("after reading");
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

```

è¿™æ ·å†™å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºè®¾ç½®ä¸ºäº†éé˜»å¡ï¼Œä¼šä¸€ç›´æ‰§è¡Œwhile(true)ä¸­çš„ä»£ç ï¼ŒCPUä¸€ç›´å¤„äºå¿™ç¢ŒçŠ¶æ€ï¼Œä¼šä½¿å¾—æ€§èƒ½å˜ä½ï¼Œæ‰€ä»¥å®é™…æƒ…å†µä¸­ä¸ä½¿ç”¨è¿™ç§æ–¹æ³•å¤„ç†è¯·æ±‚

#### å¤šè·¯å¤ç”¨

å•çº¿ç¨‹å¯ä»¥é…åˆ Selector å®Œæˆå¯¹å¤šä¸ª Channel å¯è¯»å†™äº‹ä»¶çš„ç›‘æ§ï¼Œè¿™ç§°ä¹‹ä¸ºå¤šè·¯å¤ç”¨

- **å¤šè·¯å¤ç”¨ä»…é’ˆå¯¹ç½‘ç»œ IO**ï¼Œæ™®é€šæ–‡ä»¶ IO **æ— æ³•**åˆ©ç”¨å¤šè·¯å¤ç”¨

- å¦‚æœä¸ç”¨ Selector çš„éé˜»å¡æ¨¡å¼ï¼Œçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨åšæ— ç”¨åŠŸï¼Œè€Œ Selector èƒ½å¤Ÿä¿è¯
  - æœ‰å¯è¿æ¥äº‹ä»¶æ—¶æ‰å»è¿æ¥
  - æœ‰å¯è¯»äº‹ä»¶æ‰å»è¯»å–
  - æœ‰å¯å†™äº‹ä»¶æ‰å»å†™å…¥
    - é™äºç½‘ç»œä¼ è¾“èƒ½åŠ›ï¼ŒChannel æœªå¿…æ—¶æ—¶å¯å†™ï¼Œä¸€æ—¦ Channel å¯å†™ï¼Œä¼šè§¦å‘ Selector çš„å¯å†™äº‹ä»¶

### Selector

```mermaid
graph TD
subgraph selector ç‰ˆ
thread --> selector
selector --> c1(channel)
selector --> c2(channel)
selector --> c3(channel)
end
```

å¥½å¤„

* ä¸€ä¸ªçº¿ç¨‹é…åˆ selector å°±å¯ä»¥ç›‘æ§å¤šä¸ª channel çš„äº‹ä»¶ï¼Œäº‹ä»¶å‘ç”Ÿçº¿ç¨‹æ‰å»å¤„ç†ã€‚é¿å…éé˜»å¡æ¨¡å¼ä¸‹æ‰€åšæ— ç”¨åŠŸ
* è®©è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿè¢«å……åˆ†åˆ©ç”¨
* èŠ‚çº¦äº†çº¿ç¨‹çš„æ•°é‡
* å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

#### ğŸ’¡ select ä½•æ—¶ä¸é˜»å¡

> * äº‹ä»¶å‘ç”Ÿæ—¶
>   * å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œä¼šè§¦å‘ accept äº‹ä»¶
>   * å®¢æˆ·ç«¯å‘é€æ•°æ®è¿‡æ¥ï¼Œå®¢æˆ·ç«¯æ­£å¸¸ã€å¼‚å¸¸å…³é—­æ—¶ï¼Œéƒ½ä¼šè§¦å‘ read äº‹ä»¶ï¼Œå¦å¤–å¦‚æœå‘é€çš„æ•°æ®å¤§äº buffer ç¼“å†²åŒºï¼Œä¼šè§¦å‘å¤šæ¬¡è¯»å–äº‹ä»¶
>   * channel å¯å†™ï¼Œä¼šè§¦å‘ write äº‹ä»¶
>   * åœ¨ linux ä¸‹ nio bug å‘ç”Ÿæ—¶
> * è°ƒç”¨ selector.wakeup()
> * è°ƒç”¨ selector.close()
> * selector æ‰€åœ¨çº¿ç¨‹ interrupt

### ä½¿ç”¨åŠAccpetäº‹ä»¶

è¦ä½¿ç”¨Selectorå®ç°å¤šè·¯å¤ç”¨ï¼ŒæœåŠ¡ç«¯ä»£ç å¦‚ä¸‹æ”¹è¿›

```java
public class SelectorServer {
    public static void main(String[] args) {
        // åˆ›å»ºç¼“å†²åŒº
        ByteBuffer allocate = ByteBuffer.allocate(32);
        // å¼€å¯æœåŠ¡å™¨é€šä¿¡é€šé“
        try (ServerSocketChannel serverSocketChannel = ServerSocketChannel.open()) {
            // ä¸ºæœåŠ¡å™¨ç»‘å®šç«¯å£
            serverSocketChannel.bind(new InetSocketAddress(8089));
            // è®¾ç½®æœåŠ¡å™¨é€šé“ä¸ºéé˜»å¡æ€§å½¢å¼
            serverSocketChannel.configureBlocking(false);
            // è·å–selector,å®ç°å¤šè·¯å¤ç”¨ï¼Œæ³¨æ„fileChannelæ²¡æœ‰éé˜»å¡å½¢å¼ï¼Œæ‰€ä»¥ä¸èƒ½é…åˆselectorä½¿ç”¨ï¼Œè¿›è¡Œéé˜»å¡å¤šè·¯å¤ç”¨
            Selector selector = Selector.open();
            // å°†æœåŠ¡å™¨é€šä¿¡é€šé“æ³¨å†Œåˆ°selectorä¸­ï¼Œå¹¶è®¾ç½®å…³æ³¨(æ„Ÿå…´è¶£çš„)çš„äº‹ä»¶
            serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);
            // å¾ªç¯å¤„ç†é€šé“äº‹ä»¶
            while (true) {
                System.out.println("selector before ready,thread is block");
                // è·å–åˆ°é€‰æ‹©å™¨selectorä¸­çš„äº‹ä»¶ï¼Œè‹¥æ²¡æœ‰äº‹ä»¶ï¼Œåˆ™çº¿ç¨‹ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼›åä¹‹ä¸ä¼šé˜»å¡ã€‚æ­¤ç±»ç°è±¡é¿å…äº†CPUç©ºè½¬
                // è¿”å›å€¼ä¸ºå·²ç»å°±ç»ªçš„äº‹ä»¶æ•°
                int readySelect = selector.select();
                System.out.println("selector ready counts : " + readySelect);
                // è·å–é€‰æ‹©å™¨æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> selectionKeys = selector.selectedKeys();
                // è·å–äº‹ä»¶çš„è¿­ä»£å™¨
                Iterator<SelectionKey> iterator = selectionKeys.iterator();
                while (iterator.hasNext()) {
                    // è·å–å½“å‰äº‹ä»¶çš„key
                    SelectionKey selectionKey = iterator.next();
                    // åˆ¤æ–­äº‹ä»¶çš„ç±»å‹ï¼Œä¸åŒçš„äº‹ä»¶åšå‡ºä¸åŒçš„å¤„ç†
                    if (selectionKey.isAcceptable()) {
                        // æœåŠ¡ç«¯è¿æ¥äº‹ä»¶
                        ServerSocketChannel channel = (ServerSocketChannel) selectionKey.channel();
                        System.out.println("before accepting...");
                        // è·å–é“¾æ¥é€šé“
                        SocketChannel socketChannel = channel.accept();
                        System.out.println("after accepting..." + socketChannel);
                        // éœ€è¦å°†å½“å‰çš„é€‰æ‹©å™¨äº‹ä»¶keyè¿›è¡Œç§»é™¤ï¼Œå¦åˆ™ä¸‹æ¬¡å¤„ç†äº‹ä»¶ä¼šå‡ºç° nullPointException
                        iterator.remove();
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

**æ­¥éª¤è§£æ**

- è·å¾—é€‰æ‹©å™¨Selector

```java
Selector selector = Selector.open();
```

- å°†é€šé“è®¾ç½®ä¸º**éé˜»å¡æ¨¡å¼**ï¼Œå¹¶æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­ï¼Œå¹¶è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
  - channel å¿…é¡»å·¥ä½œåœ¨éé˜»å¡æ¨¡å¼
  - FileChannel æ²¡æœ‰éé˜»å¡æ¨¡å¼ï¼Œå› æ­¤ä¸èƒ½é…åˆ selector ä¸€èµ·ä½¿ç”¨
  - ç»‘å®šçš„äº‹ä»¶ç±»å‹å¯ä»¥æœ‰ï¼š
    - **connect** - å®¢æˆ·ç«¯è¿æ¥æˆåŠŸæ—¶è§¦å‘
    - **accept** - æœåŠ¡å™¨ç«¯æˆåŠŸæ¥å—è¿æ¥æ—¶è§¦å‘
    - **read** - æ•°æ®å¯è¯»å…¥æ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºæ¥æ”¶èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½è¯»å…¥çš„æƒ…å†µ
    - **write** - æ•°æ®å¯å†™å‡ºæ—¶è§¦å‘ï¼Œæœ‰å› ä¸ºå‘é€èƒ½åŠ›å¼±ï¼Œæ•°æ®æš‚ä¸èƒ½å†™å‡ºçš„æƒ…å†µ

```java
// é€šé“å¿…é¡»è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
server.configureBlocking(false);
// å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­ï¼Œå¹¶è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
server.register(selector, SelectionKey.OP_ACCEPT);
```

- é€šè¿‡Selectorç›‘å¬äº‹ä»¶ï¼Œå¹¶è·å¾—å°±ç»ªçš„é€šé“ä¸ªæ•°ï¼Œè‹¥æ²¡æœ‰é€šé“å°±ç»ªï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡

  - é˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿ

    ```java
    int count = selector.select();
    ```

  - é˜»å¡ç›´åˆ°ç»‘å®šäº‹ä»¶å‘ç”Ÿï¼Œ**æˆ–æ˜¯è¶…æ—¶**ï¼ˆæ—¶é—´å•ä½ä¸º msï¼‰

    ```java
    int count = selector.select(long timeout);
    ```

  - **ä¸ä¼šé˜»å¡**ï¼Œä¹Ÿå°±æ˜¯ä¸ç®¡æœ‰æ²¡æœ‰äº‹ä»¶ï¼Œç«‹åˆ»è¿”å›ï¼Œè‡ªå·±æ ¹æ®è¿”å›å€¼æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶

    ```java
    int count = selector.selectNow();
    ```

- è·å–å°±ç»ªäº‹ä»¶å¹¶**å¾—åˆ°å¯¹åº”çš„é€šé“**ï¼Œç„¶åè¿›è¡Œå¤„ç†

```java
// è·å–æ‰€æœ‰äº‹ä»¶
Set<SelectionKey> selectionKeys = selector.selectedKeys();
                
// ä½¿ç”¨è¿­ä»£å™¨éå†äº‹ä»¶
Iterator<SelectionKey> iterator = selectionKeys.iterator();

while (iterator.hasNext()) {
	SelectionKey key = iterator.next();
                    
	// åˆ¤æ–­keyçš„ç±»å‹ï¼Œæ­¤å¤„ä¸ºAcceptç±»å‹
	if(key.isAcceptable()) {
        // è·å¾—keyå¯¹åº”çš„channel
        ServerSocketChannel channel = (ServerSocketChannel) key.channel();

        // è·å–è¿æ¥å¹¶å¤„ç†ï¼Œè€Œä¸”æ˜¯å¿…é¡»å¤„ç†ï¼Œå¦åˆ™éœ€è¦å–æ¶ˆ
        SocketChannel socketChannel = channel.accept();

        // å¤„ç†å®Œæ¯•åç§»é™¤
        iterator.remove();
	}
}
```

#### **ğŸ’¡ äº‹ä»¶å‘ç”Ÿåèƒ½å¦ä¸å¤„ç†**

> äº‹ä»¶å‘ç”Ÿåï¼Œ**è¦ä¹ˆå¤„ç†ï¼Œè¦ä¹ˆå–æ¶ˆï¼ˆcancelï¼‰**ï¼Œä¸èƒ½ä»€ä¹ˆéƒ½ä¸åšï¼Œ**å¦åˆ™ä¸‹æ¬¡è¯¥äº‹ä»¶ä»ä¼šè§¦å‘**ï¼Œè¿™æ˜¯å› ä¸º nio åº•å±‚ä½¿ç”¨çš„æ˜¯æ°´å¹³è§¦å‘

### Readäº‹ä»¶

- åœ¨Acceptäº‹ä»¶ä¸­ï¼Œè‹¥æœ‰å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯å»ºç«‹äº†è¿æ¥ï¼Œ**éœ€è¦å°†å…¶å¯¹åº”çš„SocketChannelè®¾ç½®ä¸ºéé˜»å¡ï¼Œå¹¶æ³¨å†Œåˆ°é€‰æ‹©å…¶ä¸­**
- æ·»åŠ Readäº‹ä»¶ï¼Œè§¦å‘åè¿›è¡Œè¯»å–æ“ä½œ

```java
public class SelectServer {
    public static void main(String[] args) {
        ByteBuffer buffer = ByteBuffer.allocate(16);
        // è·å¾—æœåŠ¡å™¨é€šé“
        try(ServerSocketChannel server = ServerSocketChannel.open()) {
            server.bind(new InetSocketAddress(8080));
            // åˆ›å»ºé€‰æ‹©å™¨
            Selector selector = Selector.open();
            // é€šé“å¿…é¡»è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
            server.configureBlocking(false);
            // å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­ï¼Œå¹¶è®¾ç½®æ„Ÿå…´è¶£çš„å®è·µ
            server.register(selector, SelectionKey.OP_ACCEPT);
            // ä¸ºserverKeyè®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
            while (true) {
                // è‹¥æ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œåä¹‹ä¸ä¼šè¢«é˜»å¡ã€‚ä»è€Œé¿å…äº†CPUç©ºè½¬
                // è¿”å›å€¼ä¸ºå°±ç»ªçš„äº‹ä»¶ä¸ªæ•°
                int ready = selector.select();
                System.out.println("selector ready counts : " + ready);
                // è·å–æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> selectionKeys = selector.selectedKeys();
                // ä½¿ç”¨è¿­ä»£å™¨éå†äº‹ä»¶
                Iterator<SelectionKey> iterator = selectionKeys.iterator();
                while (iterator.hasNext()) {
                    SelectionKey key = iterator.next();
                    // åˆ¤æ–­keyçš„ç±»å‹
                    if(key.isAcceptable()) {
                        // è·å¾—keyå¯¹åº”çš„channel
                        ServerSocketChannel channel = (ServerSocketChannel) key.channel();
                        System.out.println("before accepting...");
                        // è·å–è¿æ¥
                        SocketChannel socketChannel = channel.accept();
                        System.out.println("after accepting...");
                        // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼ŒåŒæ—¶å°†è¿æ¥çš„é€šé“ä¹Ÿæ³¨å†Œåˆ°é€‰æ‹©å…¶ä¸­
                        socketChannel.configureBlocking(false);
                        socketChannel.register(selector, SelectionKey.OP_READ);
                        // å¤„ç†å®Œæ¯•åç§»é™¤
                        iterator.remove();
                    } else if (key.isReadable()) {
                        SocketChannel channel = (SocketChannel) key.channel();
                        System.out.println("before reading...");
                        channel.read(buffer);
                        System.out.println("after reading...");
                        buffer.flip();
                        ByteBufferUtil.debugRead(buffer);
                        buffer.clear();
                        // å¤„ç†å®Œæ¯•åç§»é™¤
                        iterator.remove();
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

**åˆ é™¤äº‹ä»¶**

**å½“å¤„ç†å®Œä¸€ä¸ªäº‹ä»¶åï¼Œä¸€å®šè¦è°ƒç”¨è¿­ä»£å™¨çš„removeæ–¹æ³•ç§»é™¤å¯¹åº”äº‹ä»¶ï¼Œå¦åˆ™ä¼šå‡ºç°é”™è¯¯ã€‚**åŸå› å¦‚ä¸‹

ä»¥æˆ‘ä»¬ä¸Šé¢çš„ **Readäº‹ä»¶** çš„ä»£ç ä¸ºä¾‹

- å½“è°ƒç”¨äº† server.register(selector, SelectionKey.OP_ACCEPT)åï¼ŒSelectorä¸­ç»´æŠ¤äº†ä¸€ä¸ªé›†åˆï¼Œ**ç”¨äºå­˜æ”¾SelectionKeyä»¥åŠå…¶å¯¹åº”çš„é€šé“**

  ```java
  // WindowsSelectorImpl ä¸­çš„ SelectionKeyImplæ•°ç»„
  private SelectionKeyImpl[] channelArray = new SelectionKeyImpl[8];
  ```

  ```java
  public class SelectionKeyImpl extends AbstractSelectionKey {
      // Keyå¯¹åº”çš„é€šé“
      final SelChImpl channel;
      ...
  }
  ```

  ![image-20241028001128485](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241028001128485.png)

  - å½“**é€‰æ‹©å™¨ä¸­çš„é€šé“å¯¹åº”çš„äº‹ä»¶å‘ç”Ÿå**ï¼ŒselecionKeyä¼šè¢«æ”¾åˆ°å¦ä¸€ä¸ªé›†åˆä¸­ï¼Œä½†æ˜¯**selecionKeyä¸ä¼šè‡ªåŠ¨ç§»é™¤**ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬åœ¨å¤„ç†å®Œä¸€ä¸ªäº‹ä»¶åï¼Œé€šè¿‡è¿­ä»£å™¨æ‰‹åŠ¨ç§»é™¤å…¶ä¸­çš„selecionKeyã€‚å¦åˆ™ä¼šå¯¼è‡´å·²è¢«å¤„ç†è¿‡çš„äº‹ä»¶å†æ¬¡è¢«å¤„ç†ï¼Œå°±ä¼šå¼•å‘é”™è¯¯

    ![image-20241028001227530](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241028001227530.png)

#### æ–­å¼€å¤„ç†

å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥**æ–­å¼€æ—¶ï¼Œä¼šç»™æœåŠ¡å™¨ç«¯å‘é€ä¸€ä¸ªè¯»äº‹ä»¶**ï¼Œå¯¹å¼‚å¸¸æ–­å¼€å’Œæ­£å¸¸æ–­å¼€éœ€è¦åŠ ä»¥ä¸åŒçš„æ–¹å¼è¿›è¡Œå¤„ç†

- **æ­£å¸¸æ–­å¼€**

  - æ­£å¸¸æ–­å¼€æ—¶ï¼ŒæœåŠ¡å™¨ç«¯çš„channel.read(buffer)æ–¹æ³•çš„è¿”å›å€¼ä¸º-1ï¼Œ**æ‰€ä»¥å½“ç»“æŸåˆ°è¿”å›å€¼ä¸º-1æ—¶ï¼Œéœ€è¦è°ƒç”¨keyçš„cancelæ–¹æ³•å–æ¶ˆæ­¤äº‹ä»¶ï¼Œå¹¶åœ¨å–æ¶ˆåç§»é™¤è¯¥äº‹ä»¶**

    ```java
    int read = channel.read(buffer);
    // æ–­å¼€è¿æ¥æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªå†™äº‹ä»¶ï¼Œæ­¤æ—¶readçš„è¿”å›å€¼ä¸º-1
    if(read == -1) {
        // å–æ¶ˆè¯¥äº‹ä»¶çš„å¤„ç†
    	key.cancel();
        channel.close();
    } else {
        ...
    }
    // å–æ¶ˆæˆ–è€…å¤„ç†ï¼Œéƒ½éœ€è¦ç§»é™¤key
    iterator.remove();
    ```

- å¼‚å¸¸æ–­å¼€
  
  - å¼‚å¸¸æ–­å¼€æ—¶ï¼Œä¼šæŠ›å‡ºIOExceptionå¼‚å¸¸ï¼Œ åœ¨try-catchçš„**catchå—ä¸­æ•è·å¼‚å¸¸å¹¶è°ƒç”¨keyçš„cancelæ–¹æ³•å³å¯**

#### æ¶ˆæ¯è¾¹ç•Œ

**ä¸å¤„ç†æ¶ˆæ¯è¾¹ç•Œå­˜åœ¨çš„é—®é¢˜**

å°†ç¼“å†²åŒºçš„å¤§å°è®¾ç½®ä¸º4ä¸ªå­—èŠ‚ï¼Œå‘é€2ä¸ªæ±‰å­—ï¼ˆä½ å¥½ï¼‰ï¼Œé€šè¿‡decodeè§£ç å¹¶æ‰“å°æ—¶ï¼Œä¼šå‡ºç°ä¹±ç 

```java
ByteBuffer buffer = ByteBuffer.allocate(4);
// è§£ç å¹¶æ‰“å°
System.out.println(StandardCharsets.UTF_8.decode(buffer));
ä½ ï¿½
ï¿½ï¿½
```

è¿™æ˜¯å› ä¸ºUTF-8å­—ç¬¦é›†ä¸‹ï¼Œ1ä¸ªæ±‰å­—å ç”¨3ä¸ªå­—èŠ‚ï¼Œæ­¤æ—¶ç¼“å†²åŒºå¤§å°ä¸º4ä¸ªå­—èŠ‚ï¼Œ**ä¸€æ¬¡è¯»æ—¶é—´æ— æ³•å¤„ç†å®Œé€šé“ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¸€å…±ä¼šè§¦å‘ä¸¤æ¬¡è¯»äº‹ä»¶**ã€‚è¿™å°±å¯¼è‡´ `ä½ å¥½` çš„ `å¥½` å­—è¢«æ‹†åˆ†ä¸ºäº†å‰åŠéƒ¨åˆ†å’ŒååŠéƒ¨åˆ†å‘é€ï¼Œè§£ç æ—¶å°±ä¼šå‡ºç°é—®é¢˜

**å¤„ç†æ¶ˆæ¯è¾¹ç•Œ**

ä¼ è¾“çš„æ–‡æœ¬å¯èƒ½æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µ

- æ–‡æœ¬å¤§äºç¼“å†²åŒºå¤§å°
  - æ­¤æ—¶éœ€è¦å°†ç¼“å†²åŒºè¿›è¡Œæ‰©å®¹
- å‘ç”ŸåŠåŒ…ç°è±¡
- å‘ç”Ÿç²˜åŒ…ç°è±¡

![0023](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0023.png)

è§£å†³æ€è·¯å¤§è‡´æœ‰ä»¥ä¸‹ä¸‰ç§

- **å›ºå®šæ¶ˆæ¯é•¿åº¦**ï¼Œæ•°æ®åŒ…å¤§å°ä¸€æ ·ï¼ŒæœåŠ¡å™¨æŒ‰é¢„å®šé•¿åº¦è¯»å–ï¼Œå½“å‘é€çš„æ•°æ®è¾ƒå°‘æ—¶ï¼Œéœ€è¦å°†æ•°æ®è¿›è¡Œå¡«å……ï¼Œç›´åˆ°é•¿åº¦ä¸æ¶ˆæ¯è§„å®šé•¿åº¦ä¸€è‡´ã€‚**ç¼ºç‚¹æ˜¯æµªè´¹å¸¦å®½**
- å¦ä¸€ç§æ€è·¯æ˜¯æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†ï¼Œ**ç¼ºç‚¹æ˜¯æ•ˆç‡ä½**ï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªå­—ç¬¦åœ°å»åŒ¹é…åˆ†éš”ç¬¦
- TLV æ ¼å¼ï¼Œå³ Type ç±»å‹ã€Length é•¿åº¦ã€Value æ•°æ®ï¼Œï¼ˆä¹Ÿå°±æ˜¯åœ¨æ¶ˆæ¯å¼€å¤´ç”¨ä¸€äº›ç©ºé—´å­˜æ”¾åé¢æ•°æ®çš„é•¿åº¦ï¼Œå¦‚HTTPè¯·æ±‚å¤´ä¸­çš„Content-Typeä¸Content-Lengthï¼‰ã€‚ç±»å‹å’Œé•¿åº¦å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–æ¶ˆæ¯å¤§å°ï¼Œåˆ†é…åˆé€‚çš„ bufferï¼Œç¼ºç‚¹æ˜¯ buffer éœ€è¦æå‰åˆ†é…ï¼Œå¦‚æœå†…å®¹è¿‡å¤§ï¼Œåˆ™å½±å“ server ååé‡
  - Http 1.1 æ˜¯ TLV æ ¼å¼
  - Http 2.0 æ˜¯ LTV æ ¼å¼

ä¸‹æ–‡çš„æ¶ˆæ¯è¾¹ç•Œå¤„ç†æ–¹å¼ä¸º**ç¬¬äºŒç§ï¼šæŒ‰åˆ†éš”ç¬¦æ‹†åˆ†**

```mermaid
sequenceDiagram 
participant c1 as å®¢æˆ·ç«¯1
participant s as æœåŠ¡å™¨
participant b1 as ByteBuffer1
participant b2 as ByteBuffer2
c1 ->> s: å‘é€ 01234567890abcdef3333\r
s ->> b1: ç¬¬ä¸€æ¬¡ read å­˜å…¥ 01234567890abcdef
s ->> b2: æ‰©å®¹
b1 ->> b2: æ‹·è´ 01234567890abcdef
s ->> b2: ç¬¬äºŒæ¬¡ read å­˜å…¥ 3333\r
b2 ->> b2: 01234567890abcdef3333\r
```

**é™„ä»¶ä¸æ‰©å®¹**

Channelçš„registeræ–¹æ³•è¿˜æœ‰**ç¬¬ä¸‰ä¸ªå‚æ•°**ï¼š`é™„ä»¶`ï¼Œå¯ä»¥å‘å…¶ä¸­æ”¾å…¥ä¸€ä¸ªObjectç±»å‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¼šä¸ç™»è®°çš„Channelä»¥åŠå…¶å¯¹åº”çš„SelectionKeyç»‘å®šï¼Œå¯ä»¥ä»SelectionKeyè·å–åˆ°å¯¹åº”é€šé“çš„é™„ä»¶

```java
public final SelectionKey register(Selector sel, int ops, Object att)
```

å¯é€šè¿‡SelectionKeyçš„**attachment()æ–¹æ³•è·å¾—é™„ä»¶**

```java
ByteBuffer buffer = (ByteBuffer) key.attachment();
```

æˆ‘ä»¬éœ€è¦åœ¨Acceptäº‹ä»¶å‘ç”Ÿåï¼Œå°†é€šé“æ³¨å†Œåˆ°Selectorä¸­æ—¶ï¼Œ**å¯¹æ¯ä¸ªé€šé“æ·»åŠ ä¸€ä¸ªByteBufferé™„ä»¶**ï¼Œè®©æ¯ä¸ªé€šé“å‘ç”Ÿè¯»äº‹ä»¶æ—¶éƒ½ä½¿ç”¨è‡ªå·±çš„é€šé“ï¼Œé¿å…ä¸å…¶ä»–é€šé“å‘ç”Ÿå†²çªè€Œå¯¼è‡´é—®é¢˜

```java
// è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼ŒåŒæ—¶å°†è¿æ¥çš„é€šé“ä¹Ÿæ³¨å†Œåˆ°é€‰æ‹©å…¶ä¸­ï¼ŒåŒæ—¶è®¾ç½®é™„ä»¶
socketChannel.configureBlocking(false);
ByteBuffer buffer = ByteBuffer.allocate(16);
// æ·»åŠ é€šé“å¯¹åº”çš„Bufferé™„ä»¶
socketChannel.register(selector, SelectionKey.OP_READ, buffer);
```

å½“Channelä¸­çš„æ•°æ®å¤§äºç¼“å†²åŒºæ—¶ï¼Œéœ€è¦å¯¹ç¼“å†²åŒºè¿›è¡Œ**æ‰©å®¹**æ“ä½œã€‚æ­¤ä»£ç ä¸­çš„æ‰©å®¹çš„åˆ¤å®šæ–¹æ³•ï¼š**Channelè°ƒç”¨compactæ–¹æ³•åï¼Œçš„positionä¸limitç›¸ç­‰ï¼Œè¯´æ˜ç¼“å†²åŒºä¸­çš„æ•°æ®å¹¶æœªè¢«è¯»å–ï¼ˆå®¹é‡å¤ªå°ï¼‰ï¼Œæ­¤æ—¶åˆ›å»ºæ–°çš„ç¼“å†²åŒºï¼Œå…¶å¤§å°æ‰©å¤§ä¸ºä¸¤å€ã€‚åŒæ—¶è¿˜è¦å°†æ—§ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°æ–°çš„ç¼“å†²åŒºä¸­ï¼ŒåŒæ—¶è°ƒç”¨SelectionKeyçš„attachæ–¹æ³•å°†æ–°çš„ç¼“å†²åŒºä½œä¸ºæ–°çš„é™„ä»¶æ”¾å…¥SelectionKeyä¸­**

```java
// å¦‚æœç¼“å†²åŒºå¤ªå°ï¼Œå°±è¿›è¡Œæ‰©å®¹
if (buffer.position() == buffer.limit()) {
    ByteBuffer newBuffer = ByteBuffer.allocate(buffer.capacity()*2);
    // å°†æ—§bufferä¸­çš„å†…å®¹æ”¾å…¥æ–°çš„bufferä¸­
    ewBuffer.put(buffer);
    // å°†æ–°bufferä½œä¸ºé™„ä»¶æ”¾åˆ°keyä¸­
    key.attach(newBuffer);
}
```

**æ”¹é€ åçš„æœåŠ¡å™¨ä»£ç å¦‚ä¸‹**

```java
public class SelectServer {
    public static void main(String[] args) {
        // è·å¾—æœåŠ¡å™¨é€šé“
        try(ServerSocketChannel server = ServerSocketChannel.open()) {
            server.bind(new InetSocketAddress(8080));
            // åˆ›å»ºé€‰æ‹©å™¨
            Selector selector = Selector.open();
            // é€šé“å¿…é¡»è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
            server.configureBlocking(false);
            // å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸­ï¼Œå¹¶è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
            server.register(selector, SelectionKey.OP_ACCEPT);
            // ä¸ºserverKeyè®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶
            while (true) {
                // è‹¥æ²¡æœ‰äº‹ä»¶å°±ç»ªï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œåä¹‹ä¸ä¼šè¢«é˜»å¡ã€‚ä»è€Œé¿å…äº†CPUç©ºè½¬
                // è¿”å›å€¼ä¸ºå°±ç»ªçš„äº‹ä»¶ä¸ªæ•°
                int ready = selector.select();
                System.out.println("selector ready counts : " + ready);
                // è·å–æ‰€æœ‰äº‹ä»¶
                Set<SelectionKey> selectionKeys = selector.selectedKeys();
                // ä½¿ç”¨è¿­ä»£å™¨éå†äº‹ä»¶
                Iterator<SelectionKey> iterator = selectionKeys.iterator();
                while (iterator.hasNext()) {
                    SelectionKey key = iterator.next();
                    // åˆ¤æ–­keyçš„ç±»å‹
                    if(key.isAcceptable()) {
                        // è·å¾—keyå¯¹åº”çš„channel
                        ServerSocketChannel channel = (ServerSocketChannel) key.channel();
                        System.out.println("before accepting...");
                        // è·å–è¿æ¥
                        SocketChannel socketChannel = channel.accept();
                        System.out.println("after accepting...");
                        // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼ŒåŒæ—¶å°†è¿æ¥çš„é€šé“ä¹Ÿæ³¨å†Œåˆ°é€‰æ‹©å…¶ä¸­ï¼ŒåŒæ—¶è®¾ç½®é™„ä»¶
                        socketChannel.configureBlocking(false);
                        ByteBuffer buffer = ByteBuffer.allocate(16);
                        socketChannel.register(selector, SelectionKey.OP_READ, buffer);
                        // å¤„ç†å®Œæ¯•åç§»é™¤
                        iterator.remove();
                    } else if (key.isReadable()) {
                        SocketChannel channel = (SocketChannel) key.channel();
                        System.out.println("before reading...");
                        // é€šè¿‡keyè·å¾—é™„ä»¶ï¼ˆbufferï¼‰
                        ByteBuffer buffer = (ByteBuffer) key.attachment();
                        int read = channel.read(buffer);
                        if(read == -1) {
                            key.cancel();
                            channel.close();
                        } else {
                            // é€šè¿‡åˆ†éš”ç¬¦æ¥åˆ†éš”bufferä¸­çš„æ•°æ®
                            split(buffer);
                            // å¦‚æœç¼“å†²åŒºå¤ªå°ï¼Œå°±è¿›è¡Œæ‰©å®¹
                            if (buffer.position() == buffer.limit()) {
                                ByteBuffer newBuffer = ByteBuffer.allocate(buffer.capacity()*2);
                                // å°†æ—§bufferä¸­çš„å†…å®¹æ”¾å…¥æ–°çš„bufferä¸­
                                buffer.flip();
                                newBuffer.put(buffer);
                                // å°†æ–°bufferæ”¾åˆ°keyä¸­ä½œä¸ºé™„ä»¶
                                key.attach(newBuffer);
                            }
                        }
                        System.out.println("after reading...");
                        // å¤„ç†å®Œæ¯•åç§»é™¤
                        iterator.remove();
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private static void split(ByteBuffer buffer) {
        buffer.flip();
        for(int i = 0; i < buffer.limit(); i++) {
            // éå†å¯»æ‰¾åˆ†éš”ç¬¦
            // get(i)ä¸ä¼šç§»åŠ¨position
            if (buffer.get(i) == '\n') {
                // ç¼“å†²åŒºé•¿åº¦
                int length = i+1-buffer.position();
                ByteBuffer target = ByteBuffer.allocate(length);
                // å°†å‰é¢çš„å†…å®¹å†™å…¥targetç¼“å†²åŒº
                for(int j = 0; j < length; j++) {
                    // å°†bufferä¸­çš„æ•°æ®å†™å…¥targetä¸­
                    target.put(buffer.get());
                }
                // æ‰“å°ç»“æœ
                ByteBufferUtil.debugAll(target);
            }
        }
        // åˆ‡æ¢ä¸ºå†™æ¨¡å¼ï¼Œä½†æ˜¯ç¼“å†²åŒºå¯èƒ½æœªè¯»å®Œï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨compact
        buffer.compact();
    }
}
```

å®¢æˆ·ç«¯

```java
SocketChannel sc = SocketChannel.open();
sc.connect(new InetSocketAddress("localhost", 8080));
SocketAddress address = sc.getLocalAddress();
// sc.write(Charset.defaultCharset().encode("hello\nworld\n"));
sc.write(Charset.defaultCharset().encode("0123\n456789abcdef"));
sc.write(Charset.defaultCharset().encode("0123456789abcdef3333\n"));
System.in.read();
```

#### ByteBufferçš„å¤§å°åˆ†é…

- æ¯ä¸ª channel éƒ½éœ€è¦è®°å½•å¯èƒ½è¢«åˆ‡åˆ†çš„æ¶ˆæ¯ï¼Œå› ä¸º **ByteBuffer ä¸èƒ½è¢«å¤šä¸ª channel å…±åŒä½¿ç”¨**ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ä¸ª channel ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ ByteBuffer

- ByteBuffer ä¸èƒ½å¤ªå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ª ByteBuffer 1Mb çš„è¯ï¼Œè¦æ”¯æŒç™¾ä¸‡è¿æ¥å°±è¦ 1Tb å†…å­˜ï¼Œå› æ­¤éœ€è¦è®¾è®¡å¤§å°å¯å˜çš„ ByteBuffer
  - ä¸€ç§æ€è·¯æ˜¯é¦–å…ˆåˆ†é…ä¸€ä¸ªè¾ƒå°çš„ bufferï¼Œä¾‹å¦‚ 4kï¼Œå¦‚æœå‘ç°æ•°æ®ä¸å¤Ÿï¼Œå†åˆ†é… 8k çš„ bufferï¼Œå°† 4k buffer å†…å®¹æ‹·è´è‡³ 8k bufferï¼Œä¼˜ç‚¹æ˜¯æ¶ˆæ¯è¿ç»­å®¹æ˜“å¤„ç†ï¼Œç¼ºç‚¹æ˜¯æ•°æ®æ‹·è´è€—è´¹æ€§èƒ½ï¼Œå‚è€ƒå®ç° [http://tutorials.jenkov.com/java-performance/resizable-array.html](http://tutorials.jenkov.com/java-performance/resizable-array.html)
  - å¦ä¸€ç§æ€è·¯æ˜¯ç”¨å¤šä¸ªæ•°ç»„ç»„æˆ bufferï¼Œä¸€ä¸ªæ•°ç»„ä¸å¤Ÿï¼ŒæŠŠå¤šå‡ºæ¥çš„å†…å®¹å†™å…¥æ–°çš„æ•°ç»„ï¼Œä¸å‰é¢çš„åŒºåˆ«æ˜¯æ¶ˆæ¯å­˜å‚¨ä¸è¿ç»­è§£æå¤æ‚ï¼Œä¼˜ç‚¹æ˜¯é¿å…äº†æ‹·è´å¼•èµ·çš„æ€§èƒ½æŸè€—

### Writeäº‹ä»¶

æœåŠ¡å™¨é€šè¿‡Bufferå‘é€šé“ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œ**å¯èƒ½å› ä¸ºé€šé“å®¹é‡å°äºBufferä¸­çš„æ•°æ®å¤§å°ï¼Œå¯¼è‡´æ— æ³•ä¸€æ¬¡æ€§å°†Bufferä¸­çš„æ•°æ®å…¨éƒ¨å†™å…¥åˆ°Channelä¸­ï¼Œè¿™æ—¶ä¾¿éœ€è¦åˆ†å¤šæ¬¡å†™å…¥**ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹

- æ‰§è¡Œä¸€æ¬¡å†™æ“ä½œï¼Œå‘å°†bufferä¸­çš„å†…å®¹å†™å…¥åˆ°SocketChannelä¸­ï¼Œç„¶ååˆ¤æ–­Bufferä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®
- è‹¥Bufferä¸­è¿˜æœ‰æ•°æ®ï¼Œåˆ™**éœ€è¦å°†SockerChannelæ³¨å†Œåˆ°Seletorä¸­ï¼Œå¹¶å…³æ³¨å†™äº‹ä»¶ï¼ŒåŒæ—¶å°†æœªå†™å®Œçš„Bufferä½œä¸ºé™„ä»¶ä¸€èµ·æ”¾å…¥åˆ°SelectionKeyä¸­**

```java
 int write = socket.write(buffer);
// é€šé“ä¸­å¯èƒ½æ— æ³•æ”¾å…¥ç¼“å†²åŒºä¸­çš„æ‰€æœ‰æ•°æ®
if (buffer.hasRemaining()) {
    // æ³¨å†Œåˆ°Selectorä¸­ï¼Œå…³æ³¨å¯å†™äº‹ä»¶ï¼Œå¹¶å°†bufferæ·»åŠ åˆ°keyçš„é™„ä»¶ä¸­
    socket.configureBlocking(false);
    socket.register(selector, SelectionKey.OP_WRITE, buffer);
}
```

- æ·»åŠ å†™äº‹ä»¶çš„ç›¸å…³æ“ä½œ`key.isWritable()`ï¼Œå¯¹Bufferå†æ¬¡è¿›è¡Œå†™æ“ä½œ
  - æ¯æ¬¡å†™åéœ€è¦åˆ¤æ–­Bufferä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼ˆæ˜¯å¦å†™å®Œï¼‰ã€‚**è‹¥å†™å®Œï¼Œéœ€è¦ç§»é™¤SelecionKeyä¸­çš„Bufferé™„ä»¶ï¼Œé¿å…å…¶å ç”¨è¿‡å¤šå†…å­˜ï¼ŒåŒæ—¶è¿˜éœ€ç§»é™¤å¯¹å†™äº‹ä»¶çš„å…³æ³¨**

```java
SocketChannel socket = (SocketChannel) key.channel();
// è·å¾—buffer
ByteBuffer buffer = (ByteBuffer) key.attachment();
// æ‰§è¡Œå†™æ“ä½œ
int write = socket.write(buffer);
System.out.println(write);
// å¦‚æœå·²ç»å®Œæˆäº†å†™æ“ä½œï¼Œéœ€è¦ç§»é™¤keyä¸­çš„é™„ä»¶ï¼ŒåŒæ—¶ä¸å†å¯¹å†™äº‹ä»¶æ„Ÿå…´è¶£
if (!buffer.hasRemaining()) {
    key.attach(null);
    key.interestOps(0);
}
```

**æ•´ä½“ä»£ç å¦‚ä¸‹**

```java
public class WriteServer {

    public static void main(String[] args) throws IOException {
        ServerSocketChannel ssc = ServerSocketChannel.open();
        ssc.configureBlocking(false);
        ssc.bind(new InetSocketAddress(8080));

        Selector selector = Selector.open();
        ssc.register(selector, SelectionKey.OP_ACCEPT);

        while(true) {
            selector.select();

            Iterator<SelectionKey> iter = selector.selectedKeys().iterator();
            while (iter.hasNext()) {
                SelectionKey key = iter.next();
                iter.remove();
                if (key.isAcceptable()) {
                    SocketChannel sc = ssc.accept();
                    sc.configureBlocking(false);
                    SelectionKey sckey = sc.register(selector, SelectionKey.OP_READ);
                    // 1. å‘å®¢æˆ·ç«¯å‘é€å†…å®¹
                    StringBuilder sb = new StringBuilder();
                    for (int i = 0; i < 3000000; i++) {
                        sb.append("a");
                    }
                    ByteBuffer buffer = Charset.defaultCharset().encode(sb.toString());
                    int write = sc.write(buffer);
                    // 3. write è¡¨ç¤ºå®é™…å†™äº†å¤šå°‘å­—èŠ‚
                    System.out.println("å®é™…å†™å…¥å­—èŠ‚:" + write);
                    // 4. å¦‚æœæœ‰å‰©ä½™æœªè¯»å­—èŠ‚ï¼Œæ‰éœ€è¦å…³æ³¨å†™äº‹ä»¶
                    if (buffer.hasRemaining()) {
                        // read 1  write 4
                        // åœ¨åŸæœ‰å…³æ³¨äº‹ä»¶çš„åŸºç¡€ä¸Šï¼Œå¤šå…³æ³¨ å†™äº‹ä»¶
                        sckey.interestOps(sckey.interestOps() + SelectionKey.OP_WRITE);
                        // æŠŠ buffer ä½œä¸ºé™„ä»¶åŠ å…¥ sckey
                        sckey.attach(buffer);
                    }
                } else if (key.isWritable()) {
                    ByteBuffer buffer = (ByteBuffer) key.attachment();
                    SocketChannel sc = (SocketChannel) key.channel();
                    int write = sc.write(buffer);
                    System.out.println("å®é™…å†™å…¥å­—èŠ‚:" + write);
                    if (!buffer.hasRemaining()) { // å†™å®Œäº†
                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);
                        key.attach(null);
                    }
                }
            }
        }
    }
}
```

å®¢æˆ·ç«¯

```java
public class WriteClient {
    public static void main(String[] args) throws IOException {
        Selector selector = Selector.open();
        SocketChannel sc = SocketChannel.open();
        sc.configureBlocking(false);
        sc.register(selector, SelectionKey.OP_CONNECT | SelectionKey.OP_READ);
        sc.connect(new InetSocketAddress("localhost", 8080));
        int count = 0;
        while (true) {
            selector.select();
            Iterator<SelectionKey> iter = selector.selectedKeys().iterator();
            while (iter.hasNext()) {
                SelectionKey key = iter.next();
                iter.remove();
                if (key.isConnectable()) {
                    System.out.println(sc.finishConnect());
                } else if (key.isReadable()) {
                    ByteBuffer buffer = ByteBuffer.allocate(1024 * 1024);
                    count += sc.read(buffer);
                    buffer.clear();
                    System.out.println(count);
                }
            }
        }
    }
}
```

#### ğŸ’¡ write ä¸ºä½•è¦å–æ¶ˆ

åªè¦å‘ channel å‘é€æ•°æ®æ—¶ï¼Œsocket ç¼“å†²å¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šé¢‘ç¹è§¦å‘ï¼Œå› æ­¤åº”å½“åªåœ¨ socket ç¼“å†²åŒºå†™ä¸ä¸‹æ—¶å†å…³æ³¨å¯å†™äº‹ä»¶ï¼Œæ•°æ®å†™å®Œä¹‹åå†å–æ¶ˆå…³æ³¨