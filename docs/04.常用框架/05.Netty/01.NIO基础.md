---
title: NIOåŸºç¡€
date: 2024-10-26 14:56:58
permalink: /pages/c22ac9/
author: 
  name: ç‹èœèœ
  link: https://ca2.wang
---
> æœ¬å¥—nettyçŸ¥è¯†ç‚¹ä¸ºé»‘é©¬ç¨‹åºå‘˜-nettyçš„å­¦ä¹ è®°å½•ï¼š[ä¼ é€é—¨](https://www.bilibili.com/video/BV1py4y1E7oA/?vd_source=fa704bb6a5b4c24699d6dde3e3cad6d2)



> non-blocking io éé˜»å¡ IO

## ä¸‰å¤§ç»„ä»¶

### Channel & Buffer

channel æœ‰ä¸€ç‚¹ç±»ä¼¼äº streamï¼Œå®ƒå°±æ˜¯è¯»å†™æ•°æ®çš„**åŒå‘é€šé“**ï¼Œå¯ä»¥ä» channel å°†æ•°æ®è¯»å…¥ bufferï¼Œä¹Ÿå¯ä»¥å°† buffer çš„æ•°æ®å†™å…¥ channelï¼Œè€Œä¹‹å‰çš„ stream è¦ä¹ˆæ˜¯è¾“å…¥ï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºï¼Œchannel æ¯” stream æ›´ä¸ºåº•å±‚

```mermaid
graph LR
channel --> buffer
buffer --> channel
```

**å¸¸è§çš„Channelæœ‰ä»¥ä¸‹å››ç§**ï¼Œå…¶ä¸­`FileChannel`ä¸»è¦ç”¨äºæ–‡ä»¶ä¼ è¾“ï¼Œå…¶ä½™ä¸‰ç§ç”¨äºç½‘ç»œé€šä¿¡

* `FileChannel`
* `DatagramChannel`
* `SocketChannel`
* `ServerSocketChannel`



**Bufferæœ‰ä»¥ä¸‹å‡ ç§**ï¼Œå…¶ä¸­ä½¿ç”¨è¾ƒå¤šçš„æ˜¯ByteBuffer

* `ByteBuffer`
  * `MappedByteBuffer`
  * `DirectByteBuffer`
  * `HeapByteBuffer`
* `ShortBuffer`
* `IntBuffer`
* `LongBuffer`
* `FloatBuffer`
* `DoubleBuffer`
* `CharBuffer`

![](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/20241026171112.png)

### Selector

selector å•ä»å­—é¢æ„æ€ä¸å¥½ç†è§£ï¼Œéœ€è¦ç»“åˆæœåŠ¡å™¨çš„è®¾è®¡æ¼”åŒ–æ¥ç†è§£å®ƒçš„ç”¨é€”

åœ¨ä½¿ç”¨Selectorä¹‹å‰ï¼Œå¤„ç†socketè¿æ¥è¿˜æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•

**ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯**

ä¸ºæ¯ä¸ªè¿æ¥åˆ†åˆ«å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«å»å¤„ç†å¯¹åº”çš„sockeè¿æ¥

```mermaid
graph TD
subgraph å¤šçº¿ç¨‹ç‰ˆ
t1(thread) --> s1(socket1)
t2(thread) --> s2(socket2)
t3(thread) --> s3(socket3)
end
```

è¿™ç§æ–¹æ³•å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

- å†…å­˜å ç”¨é«˜
  - æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦å ç”¨ä¸€å®šçš„å†…å­˜ï¼Œå½“è¿æ¥è¾ƒå¤šæ—¶ï¼Œä¼šå¼€è¾Ÿå¤§é‡çº¿ç¨‹ï¼Œå¯¼è‡´å ç”¨å¤§é‡å†…å­˜
- çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬é«˜
- åªé€‚åˆè¿æ¥æ•°å°‘çš„åœºæ™¯
  - è¿æ¥æ•°è¿‡å¤šï¼Œä¼šå¯¼è‡´åˆ›å»ºå¾ˆå¤šçº¿ç¨‹ï¼Œä»è€Œå‡ºç°é—®é¢˜

**ä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯**

ä½¿ç”¨çº¿ç¨‹æ± ï¼Œè®©çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å»å¤„ç†è¿æ¥

```mermaid
graph TD
subgraph çº¿ç¨‹æ± ç‰ˆ
t4(thread) --> s4(socket1)
t5(thread) --> s5(socket2)
t4(thread) -.-> s6(socket3)
t5(thread) -.-> s7(socket4)
end
```

è¿™ç§æ–¹æ³•å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

- é˜»å¡æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä»…èƒ½å¤„ç†ä¸€ä¸ªè¿æ¥
  - çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è·å–ä»»åŠ¡ï¼ˆtaskï¼‰åï¼Œåªæœ‰å½“å…¶æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼ˆæ–­å¼€è¿æ¥åï¼‰ï¼Œæ‰ä¼šå»è·å–å¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
  - è‹¥socketè¿æ¥ä¸€ç›´æœªæ–­å¼€ï¼Œåˆ™å…¶å¯¹åº”çš„çº¿ç¨‹æ— æ³•å¤„ç†å…¶ä»–socketè¿æ¥
- ä»…é€‚åˆçŸ­è¿æ¥åœºæ™¯
  - çŸ­è¿æ¥å³å»ºç«‹è¿æ¥å‘é€è¯·æ±‚å¹¶å“åº”åå°±ç«‹å³æ–­å¼€ï¼Œä½¿å¾—çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯ä»¥å¿«é€Ÿå¤„ç†å…¶ä»–è¿æ¥

**ä½¿ç”¨é€‰æ‹©å™¨**

**selector çš„ä½œç”¨å°±æ˜¯é…åˆä¸€ä¸ªçº¿ç¨‹æ¥ç®¡ç†å¤šä¸ª channelï¼ˆfileChannelå› ä¸ºæ˜¯é˜»å¡å¼çš„ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨selectorï¼‰**ï¼Œè·å–è¿™äº› channel ä¸Šå‘ç”Ÿçš„**äº‹ä»¶**ï¼Œè¿™äº› channel å·¥ä½œåœ¨**éé˜»å¡æ¨¡å¼**ä¸‹ï¼Œä¸ä¼šè®©çº¿ç¨‹åŠæ­»åœ¨ä¸€ä¸ª channel ä¸Šã€‚å½“ä¸€ä¸ªchannelä¸­æ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå¯ä»¥å»æ‰§è¡Œå…¶ä»–channelä¸­çš„ä»»åŠ¡ã€‚**é€‚åˆè¿æ¥æ•°ç‰¹åˆ«å¤šï¼Œä½†æµé‡ä½çš„åœºæ™¯**ï¼ˆlow trafficï¼‰

```mermaid
graph TD
subgraph selector ç‰ˆ
thread --> selector
selector --> c1(channel)
selector --> c2(channel)
selector --> c3(channel)
end
```

è‹¥äº‹ä»¶æœªå°±ç»ªï¼Œè°ƒç”¨ `selector` çš„ `select()` æ–¹æ³•ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ° `channel` å‘ç”Ÿäº†è¯»å†™å°±ç»ªäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶å°±ç»ªåï¼Œ`select` æ–¹æ³•å°±ä¼šè¿”å›è¿™äº›äº‹ä»¶äº¤ç»™ `thread` æ¥å¤„ç†

### ByteBuffer

#### ä½¿ç”¨æ–¹å¼

1. å‘ buffer å†™å…¥æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ `channel.read(buffer)`
2. è°ƒç”¨ `flip()` åˆ‡æ¢è‡³`è¯»æ¨¡å¼`
   - **flipä¼šä½¿å¾—bufferä¸­çš„limitå˜ä¸ºpositionï¼Œpositionå˜ä¸º0**
3. ä» buffer è¯»å–æ•°æ®ï¼Œä¾‹å¦‚è°ƒç”¨ buffer.get()
4. è°ƒç”¨ `clear()` æˆ–è€…`compact()`åˆ‡æ¢è‡³`å†™æ¨¡å¼`
   - è°ƒç”¨clear()æ–¹æ³•æ—¶**position=0ï¼Œlimitå˜ä¸ºcapacity**
   - è°ƒç”¨compact()æ–¹æ³•æ—¶ï¼Œ**ä¼šå°†ç¼“å†²åŒºä¸­çš„æœªè¯»æ•°æ®å‹ç¼©åˆ°ç¼“å†²åŒºå‰é¢**
5. é‡å¤ä»¥ä¸Šæ­¥éª¤

#### ä½¿ç”¨æ¡ˆä¾‹

æœ‰ä¸€æ™®é€šæ–‡æœ¬æ–‡ä»¶ data.txtï¼Œå†…å®¹ä¸º

```txt
1234567890abcd
```

ä½¿ç”¨ `FileChannel` æ¥è¯»å–æ–‡ä»¶å†…å®¹

```java
@Slf4j
public class ChannelDemo1 {
    public static void main(String[] args) {
        try (RandomAccessFile file = new RandomAccessFile("helloword/data.txt", "rw")) {
            FileChannel channel = file.getChannel();
            ByteBuffer buffer = ByteBuffer.allocate(10);
            do {
                // å‘ buffer å†™å…¥
                int len = channel.read(buffer);
                log.debug("è¯»åˆ°å­—èŠ‚æ•°ï¼š{}", len);
                if (len == -1) {
                    break;
                }
                // åˆ‡æ¢ buffer è¯»æ¨¡å¼
                buffer.flip();
                while(buffer.hasRemaining()) {
                    log.debug("{}", (char)buffer.get());
                }
                // åˆ‡æ¢ buffer å†™æ¨¡å¼
                buffer.clear();
            } while (true);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

è¾“å‡º

```
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š10
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 1
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 2
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 3
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 5
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 6
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 7
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 8
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 9
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - 0
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š4
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - a
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - b
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - c
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - d
10:39:03 [DEBUG] [main] c.i.n.ChannelDemo1 - è¯»åˆ°å­—èŠ‚æ•°ï¼š-1
```

#### æ ¸å¿ƒå±æ€§

å­—èŠ‚ç¼“å†²åŒºçš„çˆ¶ç±»Bufferä¸­æœ‰å‡ ä¸ªæ ¸å¿ƒå±æ€§ï¼Œå¦‚ä¸‹

```java
// Invariants: mark <= position <= limit <= capacity
private int mark = -1;
private int position = 0;
private int limit;
private int capacity;
```

- **capacity**ï¼šç¼“å†²åŒºçš„å®¹é‡ã€‚é€šè¿‡æ„é€ å‡½æ•°èµ‹äºˆï¼Œä¸€æ—¦è®¾ç½®ï¼Œæ— æ³•æ›´æ”¹
- **limit**ï¼šç¼“å†²åŒºçš„ç•Œé™ã€‚ä½äºlimit åçš„æ•°æ®ä¸å¯è¯»å†™ã€‚ç¼“å†²åŒºçš„é™åˆ¶ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”**ä¸èƒ½å¤§äºå…¶å®¹é‡**
- **position**ï¼š**ä¸‹ä¸€ä¸ª**è¯»å†™ä½ç½®çš„ç´¢å¼•ã€‚ç¼“å†²åŒºçš„ä½ç½®ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”**ä¸èƒ½å¤§äºlimit**
- **mark**ï¼šè®°å½•å½“å‰positionçš„å€¼ã€‚**positionè¢«æ”¹å˜åï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨reset() æ–¹æ³•æ¢å¤åˆ°markçš„ä½ç½®**ã€‚

ä»¥ä¸Šå››ä¸ªå±æ€§å¿…é¡»æ»¡è¶³ä»¥ä¸‹è¦æ±‚

**mark <= position <= limit <= capacity**

ä¸€å¼€å§‹

![0021](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0021.png)

å†™æ¨¡å¼ä¸‹ï¼Œposition æ˜¯å†™å…¥ä½ç½®ï¼Œlimit ç­‰äºå®¹é‡ï¼Œä¸‹å›¾è¡¨ç¤ºå†™å…¥äº† 4 ä¸ªå­—èŠ‚åçš„çŠ¶æ€

![0018](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0018.png)

flip åŠ¨ä½œå‘ç”Ÿåï¼Œposition åˆ‡æ¢ä¸ºè¯»å–ä½ç½®ï¼Œlimit åˆ‡æ¢ä¸ºè¯»å–é™åˆ¶

![0019](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0019.png)

è¯»å– 4 ä¸ªå­—èŠ‚åï¼ŒçŠ¶æ€

![0020](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0020.png)

clear åŠ¨ä½œå‘ç”Ÿåï¼ŒçŠ¶æ€

![0021](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0021.png)

compact æ–¹æ³•ï¼Œæ˜¯æŠŠæœªè¯»å®Œçš„éƒ¨åˆ†å‘å‰å‹ç¼©ï¼Œç„¶ååˆ‡æ¢è‡³å†™æ¨¡å¼

![0022](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/0022.png)

>  **clear() VS compact()**
> clearåªæ˜¯å¯¹positionã€limitã€markè¿›è¡Œé‡ç½®ï¼Œè€Œcompactåœ¨å¯¹positionè¿›è¡Œè®¾ç½®ï¼Œä»¥åŠlimitã€markè¿›è¡Œé‡ç½®çš„åŒæ—¶ï¼Œè¿˜æ¶‰åŠåˆ°æ•°æ®åœ¨å†…å­˜ä¸­æ‹·è´ï¼ˆä¼šè°ƒç”¨`arraycopy`ï¼‰ã€‚**æ‰€ä»¥compactæ¯”clearæ›´è€—æ€§èƒ½ã€‚**ä½†compactèƒ½ä¿å­˜ä½ æœªè¯»å–çš„æ•°æ®ï¼Œå°†æ–°æ•°æ®è¿½åŠ åˆ°ä¸ºè¯»å–çš„æ•°æ®ä¹‹åï¼›è€Œclearåˆ™ä¸è¡Œï¼Œè‹¥ä½ è°ƒç”¨äº†clearï¼Œåˆ™æœªè¯»å–çš„æ•°æ®å°±æ— æ³•å†è¯»å–åˆ°äº†
>
> **æ‰€ä»¥éœ€è¦æ ¹æ®æƒ…å†µæ¥åˆ¤æ–­ä½¿ç”¨å“ªç§æ–¹æ³•è¿›è¡Œæ¨¡å¼åˆ‡æ¢**

#### ByteBuffer å¸¸è§æ–¹æ³•

##### åˆ†é…ç©ºé—´

å¯ä»¥ä½¿ç”¨ allocate æ–¹æ³•ä¸º ByteBuffer åˆ†é…ç©ºé—´ï¼Œå…¶å®ƒ buffer ç±»ä¹Ÿæœ‰è¯¥æ–¹æ³•

```java
Bytebuffer buf = ByteBuffer.allocate(16);
```

##### å‘ buffer å†™å…¥æ•°æ®

æœ‰ä¸¤ç§åŠæ³•

* è°ƒç”¨ channel çš„ read æ–¹æ³•
* è°ƒç”¨ buffer è‡ªå·±çš„ put æ–¹æ³•

```java
int readBytes = channel.read(buf);
```

å’Œ

```java
buf.put((byte)127);
```



##### ä» buffer è¯»å–æ•°æ®

åŒæ ·æœ‰ä¸¤ç§åŠæ³•

* è°ƒç”¨ channel çš„ write æ–¹æ³•
* è°ƒç”¨ buffer è‡ªå·±çš„ get æ–¹æ³•

```java
int writeBytes = channel.write(buf);
```

å’Œ

```java
byte b = buf.get();
```

get æ–¹æ³•ä¼šè®© position è¯»æŒ‡é’ˆå‘åèµ°ï¼Œå¦‚æœæƒ³é‡å¤è¯»å–æ•°æ®

* å¯ä»¥è°ƒç”¨ rewind æ–¹æ³•å°† position é‡æ–°ç½®ä¸º 0
* æˆ–è€…**è°ƒç”¨ get(int i) æ–¹æ³•è·å–ç´¢å¼• i çš„å†…å®¹ï¼Œå®ƒä¸ä¼šç§»åŠ¨è¯»æŒ‡é’ˆ**

##### mark å’Œ reset

mark æ˜¯åœ¨è¯»å–æ—¶ï¼Œåšä¸€ä¸ªæ ‡è®°ï¼Œå³ä½¿ position æ”¹å˜ï¼Œåªè¦è°ƒç”¨ reset å°±èƒ½å›åˆ° mark çš„ä½ç½®

> **æ³¨æ„**
>
> rewind å’Œ flip éƒ½ä¼šæ¸…é™¤ mark ä½ç½®

#### æ–¹æ³•è°ƒç”¨åŠæ¼”ç¤º

éœ€è¦å…ˆå¯¼å…¥nettyä¾èµ–

```xml
<dependency>
  <groupId>io.netty</groupId>
  <artifactId>netty-all</artifactId>
  <version>4.1.51.Final</version>
</dependency>
```



##### ğŸ’¡ è°ƒè¯•å·¥å…·ç±»

```java
public class ByteBufferUtil {
    private static final char[] BYTE2CHAR = new char[256];
    private static final char[] HEXDUMP_TABLE = new char[256 * 4];
    private static final String[] HEXPADDING = new String[16];
    private static final String[] HEXDUMP_ROWPREFIXES = new String[65536 >>> 4];
    private static final String[] BYTE2HEX = new String[256];
    private static final String[] BYTEPADDING = new String[16];

    static {
        final char[] DIGITS = "0123456789abcdef".toCharArray();
        for (int i = 0; i < 256; i++) {
            HEXDUMP_TABLE[i << 1] = DIGITS[i >>> 4 & 0x0F];
            HEXDUMP_TABLE[(i << 1) + 1] = DIGITS[i & 0x0F];
        }

        int i;

        // Generate the lookup table for hex dump paddings
        for (i = 0; i < HEXPADDING.length; i++) {
            int padding = HEXPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding * 3);
            for (int j = 0; j < padding; j++) {
                buf.append("   ");
            }
            HEXPADDING[i] = buf.toString();
        }

        // Generate the lookup table for the start-offset header in each row (up to 64KiB).
        for (i = 0; i < HEXDUMP_ROWPREFIXES.length; i++) {
            StringBuilder buf = new StringBuilder(12);
            buf.append(NEWLINE);
            buf.append(Long.toHexString(i << 4 & 0xFFFFFFFFL | 0x100000000L));
            buf.setCharAt(buf.length() - 9, '|');
            buf.append('|');
            HEXDUMP_ROWPREFIXES[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-hex-dump conversion
        for (i = 0; i < BYTE2HEX.length; i++) {
            BYTE2HEX[i] = ' ' + StringUtil.byteToHexStringPadded(i);
        }

        // Generate the lookup table for byte dump paddings
        for (i = 0; i < BYTEPADDING.length; i++) {
            int padding = BYTEPADDING.length - i;
            StringBuilder buf = new StringBuilder(padding);
            for (int j = 0; j < padding; j++) {
                buf.append(' ');
            }
            BYTEPADDING[i] = buf.toString();
        }

        // Generate the lookup table for byte-to-char conversion
        for (i = 0; i < BYTE2CHAR.length; i++) {
            if (i <= 0x1f || i >= 0x7f) {
                BYTE2CHAR[i] = '.';
            } else {
                BYTE2CHAR[i] = (char) i;
            }
        }
    }

    /**
     * æ‰“å°æ‰€æœ‰å†…å®¹
     * @param buffer
     */
    public static void debugAll(ByteBuffer buffer) {
        int oldlimit = buffer.limit();
        buffer.limit(buffer.capacity());
        StringBuilder origin = new StringBuilder(256);
        appendPrettyHexDump(origin, buffer, 0, buffer.capacity());
        System.out.println("+--------+-------------------- all ------------------------+----------------+");
        System.out.printf("position: [%d], limit: [%d]\n", buffer.position(), oldlimit);
        System.out.println(origin);
        buffer.limit(oldlimit);
    }

    /**
     * æ‰“å°å¯è¯»å–å†…å®¹
     * @param buffer
     */
    public static void debugRead(ByteBuffer buffer) {
        StringBuilder builder = new StringBuilder(256);
        appendPrettyHexDump(builder, buffer, buffer.position(), buffer.limit() - buffer.position());
        System.out.println("+--------+-------------------- read -----------------------+----------------+");
        System.out.printf("position: [%d], limit: [%d]\n", buffer.position(), buffer.limit());
        System.out.println(builder);
    }

    private static void appendPrettyHexDump(StringBuilder dump, ByteBuffer buf, int offset, int length) {
        if (isOutOfBounds(offset, length, buf.capacity())) {
            throw new IndexOutOfBoundsException(
                    "expected: " + "0 <= offset(" + offset + ") <= offset + length(" + length
                            + ") <= " + "buf.capacity(" + buf.capacity() + ')');
        }
        if (length == 0) {
            return;
        }
        dump.append(
                "         +-------------------------------------------------+" +
                        NEWLINE + "         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |" +
                        NEWLINE + "+--------+-------------------------------------------------+----------------+");

        final int startIndex = offset;
        final int fullRows = length >>> 4;
        final int remainder = length & 0xF;

        // Dump the rows which have 16 bytes.
        for (int row = 0; row < fullRows; row++) {
            int rowStartIndex = (row << 4) + startIndex;

            // Per-row prefix.
            appendHexDumpRowPrefix(dump, row, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + 16;
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(" |");

            // ASCII dump
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append('|');
        }

        // Dump the last row which has less than 16 bytes.
        if (remainder != 0) {
            int rowStartIndex = (fullRows << 4) + startIndex;
            appendHexDumpRowPrefix(dump, fullRows, rowStartIndex);

            // Hex dump
            int rowEndIndex = rowStartIndex + remainder;
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2HEX[getUnsignedByte(buf, j)]);
            }
            dump.append(HEXPADDING[remainder]);
            dump.append(" |");

            // Ascii dump
            for (int j = rowStartIndex; j < rowEndIndex; j++) {
                dump.append(BYTE2CHAR[getUnsignedByte(buf, j)]);
            }
            dump.append(BYTEPADDING[remainder]);
            dump.append('|');
        }

        dump.append(NEWLINE +
                "+--------+-------------------------------------------------+----------------+");
    }

    private static void appendHexDumpRowPrefix(StringBuilder dump, int row, int rowStartIndex) {
        if (row < HEXDUMP_ROWPREFIXES.length) {
            dump.append(HEXDUMP_ROWPREFIXES[row]);
        } else {
            dump.append(NEWLINE);
            dump.append(Long.toHexString(rowStartIndex & 0xFFFFFFFFL | 0x100000000L));
            dump.setCharAt(dump.length() - 9, '|');
            dump.append('|');
        }
    }

    public static short getUnsignedByte(ByteBuffer buffer, int index) {
        return (short) (buffer.get(index) & 0xFF);
    }
}
```

##### è°ƒç”¨ByteBufferçš„æ–¹æ³•

```java
public class TestByteBuffer {
    public static void main(String[] args) {
        ByteBuffer buffer = ByteBuffer.allocate(10);
        // å‘bufferä¸­å†™å…¥1ä¸ªå­—èŠ‚çš„æ•°æ®
        buffer.put((byte)97);
        // ä½¿ç”¨å·¥å…·ç±»ï¼ŒæŸ¥çœ‹bufferçŠ¶æ€
        ByteBufferUtil.debugAll(buffer);

        // å‘bufferä¸­å†™å…¥4ä¸ªå­—èŠ‚çš„æ•°æ®
        buffer.put(new byte[]{98, 99, 100, 101});
        ByteBufferUtil.debugAll(buffer);

        // è·å–æ•°æ®
        buffer.flip();
        ByteBufferUtil.debugAll(buffer);
        System.out.println(buffer.get());
        System.out.println(buffer.get());
        ByteBufferUtil.debugAll(buffer);

        // ä½¿ç”¨compactåˆ‡æ¢æ¨¡å¼
        buffer.compact();
        ByteBufferUtil.debugAll(buffer);

        // å†æ¬¡å†™å…¥
        buffer.put((byte)102);
        buffer.put((byte)103);
        ByteBufferUtil.debugAll(buffer);
    }
}

```

è¿è¡Œç»“æœ

```
// å‘ç¼“å†²åŒºå†™å…¥äº†ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ­¤æ—¶postitionä¸º1
+--------+-------------------- all ------------------------+----------------+
position: [1], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 00 00 00 00 00 00 00 00 00                   |a.........      |
+--------+-------------------------------------------------+----------------+

// å‘ç¼“å†²åŒºå†™å…¥å››ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œæ­¤æ—¶positionä¸º5
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+

// è°ƒç”¨flipåˆ‡æ¢æ¨¡å¼ï¼Œæ­¤æ—¶positionä¸º0ï¼Œè¡¨ç¤ºä»ç¬¬0ä¸ªæ•°æ®å¼€å§‹è¯»å–
+--------+-------------------- all ------------------------+----------------+
position: [0], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+
// è¯»å–ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®             
97
98
            
// positionå˜ä¸º2             
+--------+-------------------- all ------------------------+----------------+
position: [2], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 62 63 64 65 00 00 00 00 00                   |abcde.....      |
+--------+-------------------------------------------------+----------------+
             
// è°ƒç”¨compactåˆ‡æ¢æ¨¡å¼ï¼Œæ­¤æ—¶positionåŠå…¶åé¢çš„æ•°æ®è¢«å‹ç¼©åˆ°ByteBufferå‰é¢å»äº†
// æ­¤æ—¶positionä¸º3ï¼Œä¼šè¦†ç›–ä¹‹å‰çš„æ•°æ®             
+--------+-------------------- all ------------------------+----------------+
position: [3], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 64 65 64 65 00 00 00 00 00                   |cdede.....      |
+--------+-------------------------------------------------+----------------+
             
// å†æ¬¡å†™å…¥ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä¹‹å‰çš„ 0x64 0x65 è¢«è¦†ç›–         
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 64 65 66 67 00 00 00 00 00                   |cdefg.....      |
+--------+-------------------------------------------------+----------------+

```

##### è°ƒç”¨ByteBufferçš„åˆ†é…å†…å­˜çš„æ–¹æ³•

```java
public class TestByteBufferAllocate {
    public static void main(String[] args) {
        ByteBuffer allocate = ByteBuffer.allocate(10);
        ByteBuffer allocateDirect = ByteBuffer.allocateDirect(10);
        System.out.println(allocate.getClass()); // class java.nio.HeapByteBuffer å †å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œæ‰€ä»¥æ”¶åˆ°åƒåœ¾(GC)å›æ”¶çš„å½±å“ï¼›è¯»å†™æ•ˆç‡ç›¸å¯¹ä¸é«˜ï¼›
        System.out.println(allocateDirect.getClass()); // class java.nio.DirectByteBuffer ç›´æ¥å†…å­˜(ç³»ç»Ÿå†…å­˜)é‡Œé¢çš„å¯¹è±¡ï¼Œä¸ä¼šå—åˆ°åƒåœ¾å›æ”¶çš„å½±å“ï¼›è¯»å†™æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œä¼šå°‘ä¸€æ¬¡çš„å¤åˆ¶æ‹·è´ï¼›åˆ†é…æ—¶çš„æ•ˆç‡æ¯”è¾ƒä½ï¼Œå¹¶ä¸”å®¹æ˜“å‡ºç°å†…å­˜æ³„éœ²ï¼Œéœ€è¦æ‰‹åŠ¨é‡Šæ”¾å†…å­˜
    }
}
```

#### å­—ç¬¦ä¸²ä¸ ByteBuffer äº’è½¬

##### æ–¹æ³•ä¸€

**ç¼–ç **ï¼šå­—ç¬¦ä¸²è°ƒç”¨getByteæ–¹æ³•è·å¾—byteæ•°ç»„ï¼Œå°†byteæ•°ç»„æ”¾å…¥ByteBufferä¸­

**è§£ç **ï¼š**å…ˆè°ƒç”¨ByteBufferçš„flipæ–¹æ³•ï¼Œç„¶åé€šè¿‡StandardCharsetsçš„decoderæ–¹æ³•è§£ç **

```java
public class Translate {
    public static void main(String[] args) {
        // å‡†å¤‡ä¸¤ä¸ªå­—ç¬¦ä¸²
        String str1 = "hello";
        String str2 = "";


        ByteBuffer buffer1 = ByteBuffer.allocate(16);
        // é€šè¿‡å­—ç¬¦ä¸²çš„getByteæ–¹æ³•è·å¾—å­—èŠ‚æ•°ç»„ï¼Œæ”¾å…¥ç¼“å†²åŒºä¸­
        buffer1.put(str1.getBytes());
        ByteBufferUtil.debugAll(buffer1);

        // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
        // åˆ‡æ¢æ¨¡å¼
        buffer1.flip();
        
        // é€šè¿‡StandardCharsetsè§£ç ï¼Œè·å¾—CharBufferï¼Œå†é€šè¿‡toStringè·å¾—å­—ç¬¦ä¸²
        str2 = StandardCharsets.UTF_8.decode(buffer1).toString();
        System.out.println(str2);
        ByteBufferUtil.debugAll(buffer1);
    }
}
```

è¿è¡Œç»“æœ

```
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [16]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f 00 00 00 00 00 00 00 00 00 00 00 |hello...........|
+--------+-------------------------------------------------+----------------+
hello
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f 00 00 00 00 00 00 00 00 00 00 00 |hello...........|
+--------+-------------------------------------------------+----------------+
```

##### æ–¹æ³•äºŒ

**ç¼–ç **ï¼šé€šè¿‡StandardCharsetsçš„encodeæ–¹æ³•è·å¾—ByteBufferï¼Œæ­¤æ—¶è·å¾—çš„ByteBufferä¸ºè¯»æ¨¡å¼ï¼Œæ— éœ€é€šè¿‡flipåˆ‡æ¢æ¨¡å¼

**è§£ç **ï¼šé€šè¿‡StandardCharsetsçš„decoderæ–¹æ³•è§£ç 

```java
public class Translate {
    public static void main(String[] args) {
        // å‡†å¤‡ä¸¤ä¸ªå­—ç¬¦ä¸²
        String str1 = "hello";
        String str2 = "";

        // é€šè¿‡StandardCharsetsçš„encodeæ–¹æ³•è·å¾—ByteBuffer
        // æ­¤æ—¶è·å¾—çš„ByteBufferä¸ºè¯»æ¨¡å¼ï¼Œæ— éœ€é€šè¿‡flipåˆ‡æ¢æ¨¡å¼
        ByteBuffer buffer1 = StandardCharsets.UTF_8.encode(str1);
        ByteBufferUtil.debugAll(buffer1);

        // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®è½¬åŒ–ä¸ºå­—ç¬¦ä¸²
        // é€šè¿‡StandardCharsetsè§£ç ï¼Œè·å¾—CharBufferï¼Œå†é€šè¿‡toStringè·å¾—å­—ç¬¦ä¸²
        str2 = StandardCharsets.UTF_8.decode(buffer1).toString();
        System.out.println(str2);
        ByteBufferUtil.debugAll(buffer1);
    }
}
```

è¿è¡Œç»“æœ

```
+--------+-------------------- all ------------------------+----------------+
position: [0], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
hello
+--------+-------------------- all ------------------------+----------------+
position: [5], limit: [5]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 65 6c 6c 6f                                  |hello           |
+--------+-------------------------------------------------+----------------+
```

#### âš ï¸ Buffer çš„çº¿ç¨‹å®‰å…¨

> Buffer æ˜¯**éçº¿ç¨‹å®‰å…¨çš„**

#### ByteBufferåˆ†æ•£è¯»é›†ä¸­å†™

##### åˆ†æ•£è¯»

```java
public class TestScatteringRead {
    public static void main(String[] args) {
        // è·å–channelçš„ä¸¤ç§æ–¹å¼ 1. é€šè¿‡è¾“å…¥è¾“å‡ºæµgetChannelï¼›2. é€šè¿‡RandomAccessFile.getChannel()è·å–
        try (FileChannel channel = new RandomAccessFile("word1.txt", "r").getChannel()) {
            ByteBuffer allocate0 = ByteBuffer.allocate(3);
            ByteBuffer allocate1 = ByteBuffer.allocate(3);
            ByteBuffer allocate2 = ByteBuffer.allocate(5);

            // å°†é€šé“(channel)ä¸­çš„æ•°æ®ä¾æ¬¡è¯»å…¥ç¼“å­˜åŒºä¸­
            channel.read(new ByteBuffer[]{allocate0, allocate1, allocate2});
            // åˆ‡æ¢ç¼“å†²åŒºè¯»å†™æ¨¡å¼
            allocate0.flip();
            allocate1.flip();
            allocate2.flip();

            ByteBufferUtil.debugAll(allocate0);
            ByteBufferUtil.debugAll(allocate1);
            ByteBufferUtil.debugAll(allocate2);

        } catch (IOException e) {
        }
    }
}
```

##### é›†ä¸­å†™

```java
public class TestGatheringWrite {
    public static void main(String[] args) {
        // å°†æŒ‡å®šå­—ç¬¦ä¸²è½¬æ¢ä¸ºbytebuffer
        ByteBuffer buffer1 = StandardCharsets.UTF_8.encode("hello");
        ByteBuffer buffer2 = StandardCharsets.UTF_8.encode("word");
        ByteBuffer buffer3 = StandardCharsets.UTF_8.encode("æé›·");

        // è·å–åˆ°æ–‡ä»¶å¯¹åº”çš„é€šé“
        try (FileChannel channel = new RandomAccessFile("word2.txt", "rw").getChannel()) {
            // å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥é€šé“ä¸­
            channel.write(new ByteBuffer[]{buffer1, buffer2, buffer3});
        } catch (IOException e) {
        }
    }
}
```

#### ç²˜(é»)åŒ…ä¸åŠåŒ…

##### ç°è±¡

ç½‘ç»œä¸Šæœ‰å¤šæ¡æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ï¼Œæ•°æ®ä¹‹é—´ä½¿ç”¨ `\n` è¿›è¡Œåˆ†éš”
ä½†ç”±äºæŸç§åŸå› è¿™äº›æ•°æ®åœ¨æ¥æ”¶æ—¶ï¼Œè¢«è¿›è¡Œäº†é‡æ–°ç»„åˆï¼Œä¾‹å¦‚åŸå§‹æ•°æ®æœ‰3æ¡ä¸º

- `Hello,world\n`
- `Iâ€™m Nyima\n`
- `How are you?\n`

å˜æˆäº†ä¸‹é¢çš„ä¸¤ä¸ª byteBuffer (ç²˜åŒ…ï¼ŒåŠåŒ…)

- `Hello,world\nIâ€™m Nyima\nHo`
- `w are you?\n`

##### å‡ºç°åŸå› 

**ç²˜åŒ…**

å‘é€æ–¹åœ¨å‘é€æ•°æ®æ—¶ï¼Œå¹¶ä¸æ˜¯ä¸€æ¡ä¸€æ¡åœ°å‘é€æ•°æ®ï¼Œè€Œæ˜¯**å°†æ•°æ®æ•´åˆåœ¨ä¸€èµ·**ï¼Œå½“æ•°æ®è¾¾åˆ°ä¸€å®šçš„æ•°é‡åå†ä¸€èµ·å‘é€ã€‚è¿™å°±ä¼šå¯¼è‡´å¤šæ¡ä¿¡æ¯è¢«æ”¾åœ¨ä¸€ä¸ªç¼“å†²åŒºä¸­è¢«ä¸€èµ·å‘é€å‡ºå»

**åŠåŒ…**

æ¥æ”¶æ–¹çš„ç¼“å†²åŒºçš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå½“æ¥æ”¶æ–¹çš„ç¼“å†²åŒºæ»¡äº†ä»¥åï¼Œå°±éœ€è¦**å°†ä¿¡æ¯æˆªæ–­**ï¼Œç­‰ç¼“å†²åŒºç©ºäº†ä»¥åå†ç»§ç»­æ”¾å…¥æ•°æ®ã€‚è¿™å°±ä¼šå‘ç”Ÿä¸€æ®µå®Œæ•´çš„æ•°æ®æœ€åè¢«æˆªæ–­çš„ç°è±¡

##### è§£å†³åŠæ³•

- é€šè¿‡get(index)æ–¹æ³•éå†ByteBufferï¼Œé‡åˆ°åˆ†éš”ç¬¦æ—¶è¿›è¡Œå¤„ç†ã€‚

  > **æ³¨æ„ï¼š**get(index)ä¸ä¼šæ”¹å˜positionçš„å€¼

  - è®°å½•è¯¥æ®µæ•°æ®é•¿åº¦ï¼Œä»¥ä¾¿äºç”³è¯·å¯¹åº”å¤§å°çš„ç¼“å†²åŒº
  - å°†ç¼“å†²åŒºçš„æ•°æ®é€šè¿‡get()æ–¹æ³•å†™å…¥åˆ°targetä¸­

- è°ƒç”¨**compactæ–¹æ³•**åˆ‡æ¢æ¨¡å¼ï¼Œå› ä¸ºç¼“å†²åŒºä¸­å¯èƒ½è¿˜æœ‰æœªè¯»çš„æ•°æ®

```java
public class ByteBufferDemo {
    public static void main(String[] args) {
        ByteBuffer buffer = ByteBuffer.allocate(32);
        // æ¨¡æ‹Ÿç²˜åŒ…+åŠåŒ…
        buffer.put("Hello,world\nI'm Nyima\nHo".getBytes());
        // è°ƒç”¨splitå‡½æ•°å¤„ç†
        split(buffer);
        buffer.put("w are you?\n".getBytes());
        split(buffer);
    }

    private static void split(ByteBuffer buffer) {
        // åˆ‡æ¢ä¸ºè¯»æ¨¡å¼
        buffer.flip();
        for(int i = 0; i < buffer.limit(); i++) {

            // éå†å¯»æ‰¾åˆ†éš”ç¬¦
            // get(i)ä¸ä¼šç§»åŠ¨position
            if (buffer.get(i) == '\n') {
                // ç¼“å†²åŒºé•¿åº¦
                int length = i+1-buffer.position();
                ByteBuffer target = ByteBuffer.allocate(length);
                // å°†å‰é¢çš„å†…å®¹å†™å…¥targetç¼“å†²åŒº
                for(int j = 0; j < length; j++) {
                    // å°†bufferä¸­çš„æ•°æ®å†™å…¥targetä¸­
                    target.put(buffer.get());
                }
                // æ‰“å°æŸ¥çœ‹ç»“æœ
                ByteBufferUtil.debugAll(target);
            }
        }
        // åˆ‡æ¢ä¸ºå†™æ¨¡å¼ï¼Œä½†æ˜¯ç¼“å†²åŒºå¯èƒ½æœªè¯»å®Œï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨compact
        buffer.compact();
    }
}

```

è¿è¡Œç»“æœ

```
+--------+-------------------- all ------------------------+----------------+
position: [12], limit: [12]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 48 65 6c 6c 6f 2c 77 6f 72 6c 64 0a             |Hello,world.    |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [10], limit: [10]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 49 27 6d 20 4e 79 69 6d 61 0a                   |I'm Nyima.      |
+--------+-------------------------------------------------+----------------+
+--------+-------------------- all ------------------------+----------------+
position: [13], limit: [13]
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 48 6f 77 20 61 72 65 20 79 6f 75 3f 0a          |How are you?.   |
+--------+-------------------------------------------------+----------------+
```

## æ–‡ä»¶ç¼–ç¨‹

### FileChannel

#### âš ï¸ FileChannel å·¥ä½œæ¨¡å¼

> FileChannel åªèƒ½å·¥ä½œåœ¨é˜»å¡æ¨¡å¼ä¸‹ï¼Œæ‰€ä»¥æ— æ³•æ­é…Selector

#### è·å–

ä¸èƒ½ç›´æ¥æ‰“å¼€ `FileChannel`ï¼Œ**å¿…é¡»**é€šè¿‡ `FileInputStream`ã€`FileOutputStream` æˆ–è€… `RandomAccessFile` æ¥è·å– `FileChannel`ï¼Œå®ƒä»¬éƒ½æœ‰ `getChannel` æ–¹æ³•

* é€šè¿‡ `FileInputStream` è·å–çš„ channel **åªèƒ½è¯»**
* é€šè¿‡ `FileOutputStream` è·å–çš„ channel **åªèƒ½å†™**
* é€šè¿‡ `RandomAccessFile` æ˜¯å¦èƒ½è¯»å†™**æ ¹æ®æ„é€  `RandomAccessFile` æ—¶çš„è¯»å†™æ¨¡å¼å†³å®š**

#### è¯»å–

é€šè¿‡ `FileInputStream` è·å–channelï¼Œé€šè¿‡readæ–¹æ³•å°†æ•°æ®å†™å…¥åˆ°`ByteBuffer`ä¸­

readæ–¹æ³•çš„è¿”å›å€¼è¡¨ç¤ºè¯»åˆ°äº†å¤šå°‘å­—èŠ‚ï¼Œè‹¥è¯»åˆ°äº†æ–‡ä»¶æœ«å°¾åˆ™è¿”å›-1

```java
int readBytes = channel.read(buffer);
```

**å¯æ ¹æ®è¿”å›å€¼åˆ¤æ–­æ˜¯å¦è¯»å–å®Œæ¯•**

```java
while(channel.read(buffer) > 0) {
    // è¿›è¡Œå¯¹åº”æ“ä½œ
    ...
}
```



#### å†™å…¥

å› ä¸ºchannelä¹Ÿæ˜¯æœ‰å¤§å°çš„ï¼Œæ‰€ä»¥ write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channelã€‚å¿…é¡»**éœ€è¦æŒ‰ç…§ä»¥ä¸‹è§„åˆ™è¿›è¡Œå†™å…¥**

å†™å…¥çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼Œ `SocketChannel`

```java
ByteBuffer buffer = ...;
buffer.put(...); // å­˜å…¥æ•°æ®
buffer.flip();   // åˆ‡æ¢è¯»æ¨¡å¼

// é€šè¿‡hasRemaining()æ–¹æ³•æŸ¥çœ‹ç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®æœªå†™å…¥åˆ°é€šé“ä¸­
while(buffer.hasRemaining()) {
    channel.write(buffer);
}
```

åœ¨ while ä¸­è°ƒç”¨ `channel.write` æ˜¯å› ä¸º write æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ä¸€æ¬¡å°† buffer ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥ channel

#### å…³é—­

é€šé“éœ€è¦closeï¼Œä¸€èˆ¬æƒ…å†µé€šè¿‡try-with-resourceè¿›è¡Œå…³é—­ï¼Œ**æœ€å¥½ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è·å–streamä»¥åŠchannelï¼Œé¿å…æŸäº›åŸå› ä½¿å¾—èµ„æºæœªè¢«å…³é—­**

è°ƒç”¨äº† `FileInputStream`ã€`FileOutputStream` æˆ–è€… `RandomAccessFile` çš„ close æ–¹æ³•ä¼šé—´æ¥åœ°è°ƒç”¨ channel çš„ close æ–¹æ³•

```java
public class TestChannel {
    public static void main(String[] args) throws IOException {
        try (FileInputStream fis = new FileInputStream("stu.txt");
             FileOutputStream fos = new FileOutputStream("student.txt");
             FileChannel inputChannel = fis.getChannel();
             FileChannel outputChannel = fos.getChannel()) {
            
            // æ‰§è¡Œå¯¹åº”æ“ä½œ
            ...
                
        }
    }
}
```

#### ä½ç½®

**position**

channelä¹Ÿæ‹¥æœ‰ä¸€ä¸ªä¿å­˜è¯»å–æ•°æ®ä½ç½®çš„å±æ€§ï¼Œå³position

```java
long pos = channel.position();
```

å¯ä»¥é€šè¿‡position(int pos)è®¾ç½®channelä¸­positionçš„å€¼

```java
long newPos = ...;
channel.position(newPos);
```

è®¾ç½®å½“å‰ä½ç½®æ—¶ï¼Œå¦‚æœè®¾ç½®ä¸ºæ–‡ä»¶çš„æœ«å°¾

* è¿™æ—¶è¯»å–ä¼šè¿”å› -1 
* è¿™æ—¶å†™å…¥ï¼Œä¼šè¿½åŠ å†…å®¹ï¼Œä½†è¦æ³¨æ„å¦‚æœ position è¶…è¿‡äº†æ–‡ä»¶æœ«å°¾ï¼Œå†å†™å…¥æ—¶åœ¨æ–°å†…å®¹å’ŒåŸæœ«å°¾ä¹‹é—´ä¼šæœ‰ç©ºæ´ï¼ˆ00ï¼‰

#### å¤§å°

ä½¿ç”¨ size æ–¹æ³•è·å–æ–‡ä»¶çš„å¤§å°

#### å¼ºåˆ¶å†™å…¥

æ“ä½œç³»ç»Ÿå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šå°†æ•°æ®ç¼“å­˜ï¼Œä¸æ˜¯ç«‹åˆ»å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯ç­‰åˆ°ç¼“å­˜æ»¡äº†ä»¥åå°†æ‰€æœ‰æ•°æ®ä¸€æ¬¡æ€§çš„å†™å…¥ç£ç›˜ã€‚å¯ä»¥è°ƒç”¨ **force(true)** æ–¹æ³•å°†æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®ï¼ˆæ–‡ä»¶çš„æƒé™ç­‰ä¿¡æ¯ï¼‰ç«‹åˆ»å†™å…¥ç£ç›˜

### ä¸¤ä¸ªChannelä¼ è¾“æ•°æ®

#### transferToæ–¹æ³•

ä½¿ç”¨`transferTo`æ–¹æ³•å¯ä»¥å¿«é€Ÿã€é«˜æ•ˆåœ°å°†ä¸€ä¸ª`channel`ä¸­çš„æ•°æ®ä¼ è¾“åˆ°å¦ä¸€ä¸ª`channel`ä¸­ï¼Œä½†**ä¸€æ¬¡åªèƒ½ä¼ è¾“2Gçš„å†…å®¹**

`transferTo`åº•å±‚ä½¿ç”¨äº†é›¶æ‹·è´æŠ€æœ¯

```java
public class TestChannel {
    public static void main(String[] args){
        try (FileInputStream fis = new FileInputStream("stu.txt");
             FileOutputStream fos = new FileOutputStream("student.txt");
             FileChannel inputChannel = fis.getChannel();
             FileChannel outputChannel = fos.getChannel()) {
            // å‚æ•°ï¼šinputChannelçš„èµ·å§‹ä½ç½®ï¼Œä¼ è¾“æ•°æ®çš„å¤§å°ï¼Œç›®çš„channel
            // è¿”å›å€¼ä¸ºä¼ è¾“çš„æ•°æ®çš„å­—èŠ‚æ•°
            // transferToä¸€æ¬¡åªèƒ½ä¼ è¾“2Gçš„æ•°æ®
            inputChannel.transferTo(0, inputChannel.size(), outputChannel);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

å½“ä¼ è¾“çš„æ–‡ä»¶**å¤§äº2G**æ—¶ï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œå¤šæ¬¡ä¼ è¾“

```java
public class TestChannel {
    public static void main(String[] args){
        try (FileInputStream fis = new FileInputStream("stu.txt");
             FileOutputStream fos = new FileOutputStream("student.txt");
             FileChannel inputChannel = fis.getChannel();
             FileChannel outputChannel = fos.getChannel()) {
            long size = inputChannel.size();
            long capacity = inputChannel.size();
            // åˆ†å¤šæ¬¡ä¼ è¾“
            while (capacity > 0) {
                // transferToè¿”å›å€¼ä¸ºä¼ è¾“äº†çš„å­—èŠ‚æ•°
                capacity -= inputChannel.transferTo(size-capacity, capacity, outputChannel);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### Pathä¸Paths

jdk7 å¼•å…¥äº† Path å’Œ Paths ç±»

* Path ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶è·¯å¾„
* Paths æ˜¯å·¥å…·ç±»ï¼Œç”¨æ¥è·å– Path å®ä¾‹

```java
Path source = Paths.get("1.txt"); // ç›¸å¯¹è·¯å¾„ ä½¿ç”¨ user.dir ç¯å¢ƒå˜é‡æ¥å®šä½ 1.txt

Path source = Paths.get("d:\\1.txt"); // ç»å¯¹è·¯å¾„ ä»£è¡¨äº†  d:\1.txt

Path source = Paths.get("d:/1.txt"); // ç»å¯¹è·¯å¾„ åŒæ ·ä»£è¡¨äº†  d:\1.txt

Path projects = Paths.get("d:\\data", "projects"); // ä»£è¡¨äº†  d:\data\projects
```

* `.` ä»£è¡¨äº†å½“å‰è·¯å¾„
* `..` ä»£è¡¨äº†ä¸Šä¸€çº§è·¯å¾„

ä¾‹å¦‚ç›®å½•ç»“æ„å¦‚ä¸‹

```
d:
	|- data
		|- projects
			|- a
			|- b
```

ä»£ç 

```java
Path path = Paths.get("d:\\data\\projects\\a\\..\\b");
System.out.println(path);
System.out.println(path.normalize()); // æ­£å¸¸åŒ–è·¯å¾„ä¼šå»é™¤ . ä»¥åŠ ..
```

è¾“å‡ºç»“æœä¸º

```
d:\data\projects\a\..\b
d:\data\projects\b
```

### Files

#### æŸ¥æ‰¾

æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨

```java
Path path = Paths.get("helloword/data.txt");
System.out.println(Files.exists(path));
```

#### åˆ›å»º

åˆ›å»º**ä¸€çº§ç›®å½•**

```java
Path path = Paths.get("helloword/d1");
Files.createDirectory(path);
```

* å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ `FileAlreadyExistsException`
* ä¸èƒ½ä¸€æ¬¡åˆ›å»ºå¤šçº§ç›®å½•ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ `NoSuchFileException`

åˆ›å»º**å¤šçº§ç›®å½•ç”¨**

```java
Path path = Paths.get("helloword/d1/d2");
Files.createDirectories(path);
```

#### æ‹·è´åŠç§»åŠ¨

**æ‹·è´æ–‡ä»¶**

```java
Path source = Paths.get("helloword/data.txt");
Path target = Paths.get("helloword/target.txt");

Files.copy(source, target);
```

* å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ `FileAlreadyExistsException`

å¦‚æœå¸Œæœ›ç”¨ `source` è¦†ç›–æ‰ `target`ï¼Œéœ€è¦ç”¨ `StandardCopyOption` æ¥æ§åˆ¶

```java
Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);
```



ç§»åŠ¨æ–‡ä»¶

```java
Path source = Paths.get("helloword/data.txt");
Path target = Paths.get("helloword/data.txt");

Files.move(source, target, StandardCopyOption.ATOMIC_MOVE);
```

* **`StandardCopyOption.ATOMIC_MOVE` ä¿è¯æ–‡ä»¶ç§»åŠ¨çš„åŸå­æ€§**

åˆ é™¤æ–‡ä»¶

```java
Path target = Paths.get("helloword/target.txt");

Files.delete(target);
```

* å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¼šæŠ›å¼‚å¸¸ `NoSuchFileException`

åˆ é™¤ç›®å½•

```java
Path target = Paths.get("helloword/d1");

Files.delete(target);
```

* å¦‚æœ**ç›®å½•è¿˜æœ‰å†…å®¹**ï¼Œä¼šæŠ›å¼‚å¸¸ `DirectoryNotEmptyException`

#### éå†

å¯ä»¥**ä½¿ç”¨Fileså·¥å…·ç±»ä¸­çš„walkFileTree(Path, FileVisitor)æ–¹æ³•**ï¼Œå…¶ä¸­éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°

- `Path`ï¼šæ–‡ä»¶èµ·å§‹è·¯å¾„
- `FileVisitor`ï¼šæ–‡ä»¶è®¿é—®å™¨ï¼Œä½¿ç”¨è®¿é—®è€…æ¨¡å¼
  - æ¥å£çš„å®ç°ç±»`SimpleFileVisitor`æœ‰å››ä¸ªæ–¹æ³•ï¼š
    - `preVisitDirectory`ï¼šè®¿é—®ç›®å½•å‰çš„æ“ä½œ
    - `visitFile`ï¼šè®¿é—®æ–‡ä»¶çš„æ“ä½œ
    - `visitFileFailed`ï¼šè®¿é—®æ–‡ä»¶å¤±è´¥æ—¶çš„æ“ä½œ
    - `postVisitDirectory`ï¼šè®¿é—®ç›®å½•åçš„æ“ä½œ

éå†ç›®å½•æ–‡ä»¶

```java
public class TestWalkFileTree {
    public static void main(String[] args) throws IOException {
        Path path = Paths.get("D:\\JDK 8");
        // æ–‡ä»¶ç›®å½•æ•°ç›®
        AtomicInteger dirCount = new AtomicInteger();
        // æ–‡ä»¶æ•°ç›®
        AtomicInteger fileCount = new AtomicInteger();
        Files.walkFileTree(path, new SimpleFileVisitor<Path>(){
            @Override
            public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException {
                System.out.println("===>"+dir);
                // å¢åŠ æ–‡ä»¶ç›®å½•æ•°
                dirCount.incrementAndGet();
                return super.preVisitDirectory(dir, attrs);
            }

            @Override
            public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {
                System.out.println(file);
                // å¢åŠ æ–‡ä»¶æ•°
                fileCount.incrementAndGet();
                return super.visitFile(file, attrs);
            }
        });
        // æ‰“å°æ•°ç›®
        System.out.println("æ–‡ä»¶ç›®å½•æ•°:"+dirCount.get());
        System.out.println("æ–‡ä»¶æ•°:"+fileCount.get());
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹

```
...
===>D:\JDK 8\lib\security\policy\unlimited
D:\JDK 8\lib\security\policy\unlimited\local_policy.jar
D:\JDK 8\lib\security\policy\unlimited\US_export_policy.jar
D:\JDK 8\lib\security\trusted.libraries
D:\JDK 8\lib\sound.properties
D:\JDK 8\lib\tzdb.dat
D:\JDK 8\lib\tzmappings
D:\JDK 8\LICENSE
æ–‡ä»¶ç›®å½•æ•°:23
æ–‡ä»¶æ•°:280
```

ç»Ÿè®¡ jar çš„æ•°ç›®

```java
Path path = Paths.get("C:\\Program Files\\Java\\jdk1.8.0_91");
AtomicInteger fileCount = new AtomicInteger();
Files.walkFileTree(path, new SimpleFileVisitor<Path>(){
    @Override
    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) 
        throws IOException {
        if (file.toFile().getName().endsWith(".jar")) {
            fileCount.incrementAndGet();
        }
        return super.visitFile(file, attrs);
    }
});
System.out.println(fileCount); // 724
```



åˆ é™¤å¤šçº§ç›®å½•

```java
Path path = Paths.get("d:\\a");
Files.walkFileTree(path, new SimpleFileVisitor<Path>(){
    @Override
    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) 
        throws IOException {
        Files.delete(file);
        return super.visitFile(file, attrs);
    }

    @Override
    public FileVisitResult postVisitDirectory(Path dir, IOException exc) 
        throws IOException {
        Files.delete(dir);
        return super.postVisitDirectory(dir, exc);
    }
});
```

> âš ï¸ åˆ é™¤å¾ˆå±é™©
>
> åˆ é™¤æ˜¯å±é™©æ“ä½œï¼Œç¡®ä¿è¦é€’å½’åˆ é™¤çš„æ–‡ä»¶å¤¹æ²¡æœ‰é‡è¦å†…å®¹

æ‹·è´å¤šçº§ç›®å½•

```java
long start = System.currentTimeMillis();
String source = "D:\\Snipaste-1.16.2-x64";
String target = "D:\\Snipaste-1.16.2-x64aaa";

Files.walk(Paths.get(source)).forEach(path -> {
    try {
        String targetName = path.toString().replace(source, target);
        // æ˜¯ç›®å½•
        if (Files.isDirectory(path)) {
            Files.createDirectory(Paths.get(targetName));
        }
        // æ˜¯æ™®é€šæ–‡ä»¶
        else if (Files.isRegularFile(path)) {
            Files.copy(path, Paths.get(targetName));
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
});
long end = System.currentTimeMillis();
System.out.println(end - start);
```

## ç½‘ç»œç¼–ç¨‹

### é˜»å¡

- é˜»å¡æ¨¡å¼ä¸‹ï¼Œç›¸å…³æ–¹æ³•éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æš‚åœ
  - `ServerSocketChannel.accept` ä¼šåœ¨**æ²¡æœ‰è¿æ¥å»ºç«‹æ—¶**è®©çº¿ç¨‹æš‚åœ
  - `SocketChannel.read` ä¼šåœ¨**é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶**è®©çº¿ç¨‹æš‚åœ
  - é˜»å¡çš„è¡¨ç°å…¶å®å°±æ˜¯çº¿ç¨‹æš‚åœäº†ï¼Œæš‚åœæœŸé—´ä¸ä¼šå ç”¨ cpuï¼Œä½†çº¿ç¨‹ç›¸å½“äºé—²ç½®ï¼Œä¸èƒ½å¤„ç†å…¶ä»–çš„ä»»åŠ¡

* å•çº¿ç¨‹ä¸‹ï¼Œé˜»å¡æ–¹æ³•ä¹‹é—´ç›¸äº’å½±å“ï¼Œå‡ ä¹ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦å¤šçº¿ç¨‹æ”¯æŒ
* ä½†å¤šçº¿ç¨‹ä¸‹ï¼Œæœ‰æ–°çš„é—®é¢˜ï¼Œä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢
  * **32 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 320kï¼Œ64 ä½ jvm ä¸€ä¸ªçº¿ç¨‹ 1024kï¼Œå¦‚æœè¿æ¥æ•°è¿‡å¤šï¼Œå¿…ç„¶å¯¼è‡´ OOMï¼Œå¹¶ä¸”çº¿ç¨‹å¤ªå¤šï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æ€§èƒ½é™ä½**
  * å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯æ¥å‡å°‘çº¿ç¨‹æ•°å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿æ¥å»ºç«‹ï¼Œä½†é•¿æ—¶é—´ inactiveï¼Œä¼šé˜»å¡çº¿ç¨‹æ± ä¸­æ‰€æœ‰çº¿ç¨‹ï¼Œ**å› æ­¤ä¸é€‚åˆé•¿è¿æ¥ï¼Œåªé€‚åˆçŸ­è¿æ¥**

æœåŠ¡å™¨ç«¯

```java
public class Server {
    public static void main(String[] args) {
        // åˆ›å»ºç¼“å†²åŒº
        ByteBuffer buffer = ByteBuffer.allocate(16);
        // è·å¾—æœåŠ¡å™¨é€šé“
        try(ServerSocketChannel server = ServerSocketChannel.open()) {
            // ä¸ºæœåŠ¡å™¨é€šé“ç»‘å®šç«¯å£
            server.bind(new InetSocketAddress(8089));
            // ç”¨æˆ·å­˜æ”¾è¿æ¥çš„é›†åˆ
            ArrayList<SocketChannel> channels = new ArrayList<>();
            // å¾ªç¯æ¥æ”¶è¿æ¥
            while (true) {
                System.out.println("before connecting...");
                // æ²¡æœ‰è¿æ¥æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹
                SocketChannel socketChannel = server.accept();
                System.out.println("after connecting...");
                channels.add(socketChannel);
                // å¾ªç¯éå†é›†åˆä¸­çš„è¿æ¥
                for(SocketChannel channel : channels) {
                    System.out.println("before reading");
                    // å¤„ç†é€šé“ä¸­çš„æ•°æ®
                    // å½“é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹
                    channel.read(buffer);
                    buffer.flip();
                    ByteBufferUtil.debugRead(buffer);
                    buffer.clear();
                    System.out.println("after reading");
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

å®¢æˆ·ç«¯

```java
public class Client {
    public static void main(String[] args) {
        try (SocketChannel socketChannel = SocketChannel.open()) {
            socketChannel.connect(new InetSocketAddress("localhost", 8089));
            socketChannel.write(StandardCharsets.UTF_8.encode("hello"));
            System.out.println("waiting...");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

è¿è¡Œç»“æœ

- å®¢æˆ·ç«¯-æœåŠ¡å™¨å»ºç«‹è¿æ¥å‰ï¼šæœåŠ¡å™¨ç«¯å› accepté˜»å¡

![image-20241027003401988](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027003401988.png)

- å®¢æˆ·ç«¯-æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼Œå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯å‰ï¼šæœåŠ¡å™¨ç«¯å› é€šé“ä¸ºç©ºè¢«é˜»å¡

![image-20241027003652183](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027003652183.png)

- å®¢æˆ·ç«¯å‘é€æ•°æ®åï¼ŒæœåŠ¡å™¨å¤„ç†é€šé“ä¸­çš„æ•°æ®ã€‚å†æ¬¡è¿›å…¥å¾ªç¯æ—¶ï¼Œå†æ¬¡è¢«accepté˜»å¡

![image-20241027003721424](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027003721424.png)

- ä¹‹å‰çš„å®¢æˆ·ç«¯å†æ¬¡å‘é€æ¶ˆæ¯**ï¼ŒæœåŠ¡å™¨ç«¯å› ä¸ºè¢«accepté˜»å¡**ï¼Œæ— æ³•å¤„ç†ä¹‹å‰å®¢æˆ·ç«¯å‘é€åˆ°é€šé“ä¸­çš„ä¿¡æ¯

![image-20241027005059928](https://cdn.jsdmirror.com/gh/Cai2w/cdn/img/image-20241027005059928.png)

### éé˜»å¡

- å¯ä»¥é€šè¿‡`ServerSocketChannel`çš„`configureBlocking(false)`æ–¹æ³•å°†**è·å¾—è¿æ¥**è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚æ­¤æ—¶è‹¥æ²¡æœ‰è¿æ¥ï¼Œ`accept`ä¼šè¿”å›`null`
- å¯ä»¥é€šè¿‡`SocketChannel`çš„`configureBlocking(false)`æ–¹æ³•å°†ä»é€šé“ä¸­**è¯»å–æ•°æ®**è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚**è‹¥æ­¤æ—¶é€šé“ä¸­æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œreadä¼šè¿”å›0**

* ä½†éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥å»ºç«‹ï¼Œå’Œå¯è¯»æ•°æ®ï¼Œçº¿ç¨‹ä»ç„¶åœ¨ä¸æ–­è¿è¡Œï¼Œç™½ç™½æµªè´¹äº† cpu
* æ•°æ®å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯é˜»å¡çš„ï¼ˆAIO æ”¹è¿›çš„åœ°æ–¹ï¼‰

æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯ä»£ç ä¸å˜

```
public class Server {
 public static void main(String[] args) {
        // åˆ›å»ºç¼“å†²åŒº
        ByteBuffer buffer = ByteBuffer.allocate(16);
        // è·å¾—æœåŠ¡å™¨é€šé“
        try (ServerSocketChannel serverSocketChannel = ServerSocketChannel.open()) {
            // ä¸ºæœåŠ¡å™¨é€šé“ç»‘å®šç«¯å£
            serverSocketChannel.bind(new InetSocketAddress(8089));
            // å°†æœåŠ¡ç«¯è¿æ¥é€šé“è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œæ­¤ç§çŠ¶æ¨¡å¼ï¼Œserver.accept()åœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚å»ºç«‹æ—¶ï¼Œè¿”å›å€¼æ˜¯nullæ­¤æ—¶è‹¥æ²¡æœ‰è¿æ¥ï¼Œacceptä¼šè¿”å›null
            serverSocketChannel.configureBlocking(false);
            // ç”¨æˆ·å­˜æ”¾è¿æ¥çš„é›†åˆ
            List<SocketChannel> channelList = new ArrayList<>();
            // å¾ªç¯æ¥æ”¶è¿æ¥
            while (true) {
                // configureBlocking = false ï¼ˆéé˜»å¡æ¨¡å¼ï¼‰ä¸‹ï¼Œæ‰§è¡Œåˆ°æ­¤ä»£ç ï¼Œå¦‚æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚å»ºç«‹ï¼Œè¿”å›å€¼ä¸ºnull
                SocketChannel socketChannel = serverSocketChannel.accept();
                // é€šé“ä¸ä¸ºç©ºæ—¶æ‰å°†è¿æ¥æ”¾å…¥åˆ°é›†åˆä¸­
                if (null != socketChannel) {
                    System.out.println("client connecting...");
                    // å®¢æˆ·ç«¯socketé€šé“ï¼Œè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œåˆ™ä½¿ç”¨channel.read()æ˜¯éé˜»å¡ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹çš„æ‰§è¡Œ
                    socketChannel.configureBlocking(false);
                    channelList.add(socketChannel);
                }
                for (SocketChannel channel : channelList) {
                    // å¤„ç†é€šé“ä¸­çš„æ•°æ®
                    // åœ¨é€šé“channelçš„configureBlocking = false ï¼ˆéé˜»å¡æ¨¡å¼ï¼‰ä¸‹ï¼Œè‹¥é€šé“ä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™è¿”å›å€¼æ˜¯0ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹çš„æ‰§è¡Œ
                    int read = channel.read(buffer);
                    if (read > 0) {
                        buffer.flip();
                        ByteBufferUtil.debugRead(buffer);
                        buffer.clear();
                        System.out.println("after reading");
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

```

